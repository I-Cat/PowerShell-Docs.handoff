{"nodes":[{"pos":[32,71],"content":"Validate Port Mirroring | Microsoft ATA","needQuote":true,"nodes":[{"content":"Validate Port Mirroring | Microsoft ATA","pos":[0,39]}]},{"pos":[85,154],"content":"Describes how to validate that port mirroring is configured correctly","needQuote":true,"nodes":[{"content":"Describes how to validate that port mirroring is configured correctly","pos":[0,69]}]},{"content":"Applies to: Advanced Threat Analytics version 1.7","pos":[484,533]},{"pos":[540,563],"content":"Validate Port Mirroring","linkify":"Validate Port Mirroring","nodes":[{"content":"Validate Port Mirroring","pos":[0,23]}]},{"pos":[566,885],"content":"[!NOTE] \nThis article is relevant only if you deploy ATA Gateways instead of ATA Lightweight Gateways. To determine if you need to use ATA Gateways, see [Choosing the right gateways for your deployment](/advanced-threat-analytics/plan-design/ata-capacity-planning#choosing-the-right-gateway-type-for-your-deployment).","leadings":["","> "],"nodes":[{"content":"This article is relevant only if you deploy ATA Gateways instead of ATA Lightweight Gateways. To determine if you need to use ATA Gateways, see [Choosing the right gateways for your deployment](/advanced-threat-analytics/plan-design/ata-capacity-planning#choosing-the-right-gateway-type-for-your-deployment).","pos":[9,317],"nodes":[{"content":"This article is relevant only if you deploy ATA Gateways instead of ATA Lightweight Gateways.","pos":[0,93]},{"content":"To determine if you need to use ATA Gateways, see <bpt id=\"p1\">[</bpt>Choosing the right gateways for your deployment<ept id=\"p1\">](/advanced-threat-analytics/plan-design/ata-capacity-planning#choosing-the-right-gateway-type-for-your-deployment)</ept>.","pos":[94,308],"source":" To determine if you need to use ATA Gateways, see [Choosing the right gateways for your deployment](/advanced-threat-analytics/plan-design/ata-capacity-planning#choosing-the-right-gateway-type-for-your-deployment)."}]}]},{"content":"The following steps walk you through the process for validating that port mirroring is properly configured.","pos":[888,995]},{"content":"For ATA to work properly, the ATA Gateway must be able to see the traffic to and from the domain controller.","pos":[996,1104]},{"content":"The main data source used by ATA is deep packet inspection of the network traffic to and from your domain controllers.","pos":[1105,1223]},{"content":"For ATA to see the network traffic, port mirroring needs to be configured.","pos":[1224,1298]},{"content":"Port mirroring copies the traffic from one port (the source port) to another port (the destination port).","pos":[1299,1404]},{"pos":[1409,1466],"content":"Validate port mirroring using a Windows PowerShell script","linkify":"Validate port mirroring using a Windows PowerShell script","nodes":[{"content":"Validate port mirroring using a Windows PowerShell script","pos":[0,57]}]},{"pos":[1471,1533],"content":"Save the text of this script into a file called <bpt id=\"p1\">*</bpt>ATAdiag.ps1<ept id=\"p1\">*</ept>.","source":"Save the text of this script into a file called *ATAdiag.ps1*."},{"content":"Run this script on the ATA Gateway that you want to validate.","pos":[1537,1598]},{"content":"The script generates ICMP traffic from the ATA Gateway to the domain controller and looks for that traffic on the Capture NIC on the domain controller.","pos":[1599,1750],"source":"\nThe script generates ICMP traffic from the ATA Gateway to the domain controller and looks for that traffic on the Capture NIC on the domain controller."},{"content":"If the ATA Gateway sees ICMP traffic with a destination IP address the same as the DC IP addressed you entered in the ATA Console, it deems port mirroring configured.","pos":[1751,1917],"source":"\nIf the ATA Gateway sees ICMP traffic with a destination IP address the same as the DC IP addressed you entered in the ATA Console, it deems port mirroring configured."},{"content":"Sample for how to run the script:","pos":[1920,1953]},{"pos":[7734,7771],"content":"Validate port mirroring using Net Mon","linkify":"Validate port mirroring using Net Mon","nodes":[{"content":"Validate port mirroring using Net Mon","pos":[0,37]}]},{"pos":[7776,7918],"content":"Install <bpt id=\"p1\">[</bpt>Microsoft Network Monitor 3.4<ept id=\"p1\">](http://www.microsoft.com/download/details.aspx?id=4865)</ept> on the ATA Gateway that you want to validate..","source":"Install [Microsoft Network Monitor 3.4](http://www.microsoft.com/download/details.aspx?id=4865) on the ATA Gateway that you want to validate.."},{"pos":[7926,8045],"content":"[!IMPORTANT]\nDo not install Microsoft Message Analyzer, or any other traffic capture software on the ATA Gateway.","leadings":["","    > "],"nodes":[{"content":"Do not install Microsoft Message Analyzer, or any other traffic capture software on the ATA Gateway.","pos":[13,113]}]},{"content":"Open Network Monitor and create a new capture tab.","pos":[8051,8101]},{"pos":[8111,8268],"content":"Select only the <bpt id=\"p1\">**</bpt>Capture<ept id=\"p1\">**</ept> network adapter or the network adapter that is connected to the switch port that is configured as the port mirroring destination.","source":"Select only the **Capture** network adapter or the network adapter that is connected to the switch port that is configured as the port mirroring destination."},{"content":"Ensure that P-Mode is enabled.","pos":[8278,8308]},{"pos":[8318,8340],"content":"Click <bpt id=\"p1\">**</bpt>New Capture<ept id=\"p1\">**</ept>.","source":"Click **New Capture**."},{"content":"Create new capture tab image","pos":[8352,8380]},{"pos":[8425,8531],"content":"In the Display Filter window, enter the following filter: <bpt id=\"p1\">**</bpt>KerberosV5 OR LDAP<ept id=\"p1\">**</ept> and then click <bpt id=\"p2\">**</bpt>Apply<ept id=\"p2\">**</ept>.","source":"In the Display Filter window, enter the following filter: **KerberosV5 OR LDAP** and then click **Apply**."},{"content":"Apply KerberosV5 or LDAP filter image","pos":[8539,8576]},{"content":"Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept> to start the capture session.","pos":[8629,8674],"source":"Click **Start** to start the capture session."},{"content":"If you do not see traffic to and from the domain controller, review your port mirroring configuration.","pos":[8675,8777]},{"content":"Start capture session image","pos":[8785,8812]},{"pos":[8867,8961],"content":"[!NOTE]\nIt is important to make sure you see traffic to and from the domain controllers.","leadings":["","    > "],"nodes":[{"content":"It is important to make sure you see traffic to and from the domain controllers.","pos":[8,88]}]},{"content":"If you only see traffic in one direction, you should work with your networking or virtualization teams to help troubleshoot your port mirroring configuration.","pos":[8972,9130]},{"pos":[9135,9143],"content":"See Also","linkify":"See Also","nodes":[{"content":"See Also","pos":[0,8]}]},{"content":"Configure port mirroring","pos":[9148,9172]},{"content":"Check out the ATA forum!","pos":[9206,9230]}],"content":"---\n# required metadata\n\ntitle: Validate Port Mirroring | Microsoft ATA\ndescription: Describes how to validate that port mirroring is configured correctly\nkeywords:\nauthor: rkarlin\nmanager: mbaldwin\nms.date: 08/24/2016\nms.topic: get-started-article\nms.prod:\nms.service: advanced-threat-analytics\nms.technology:\nms.assetid: ebd41719-c91a-4fdd-bcab-2affa2a2cace\n\n# optional metadata\n\n#ROBOTS:\n#audience:\n#ms.devlang:\nms.reviewer: bennyl\nms.suite: ems\n#ms.tgt_pltfrm:\n#ms.custom:\n\n---\n\n*Applies to: Advanced Threat Analytics version 1.7*\n\n\n\n# Validate Port Mirroring\n> [!NOTE] \n> This article is relevant only if you deploy ATA Gateways instead of ATA Lightweight Gateways. To determine if you need to use ATA Gateways, see [Choosing the right gateways for your deployment](/advanced-threat-analytics/plan-design/ata-capacity-planning#choosing-the-right-gateway-type-for-your-deployment).\n \nThe following steps walk you through the process for validating that port mirroring is properly configured. For ATA to work properly, the ATA Gateway must be able to see the traffic to and from the domain controller. The main data source used by ATA is deep packet inspection of the network traffic to and from your domain controllers. For ATA to see the network traffic, port mirroring needs to be configured. Port mirroring copies the traffic from one port (the source port) to another port (the destination port).\n\n## Validate port mirroring using a Windows PowerShell script\n\n1. Save the text of this script into a file called *ATAdiag.ps1*.\n2. Run this script on the ATA Gateway that you want to validate.\nThe script generates ICMP traffic from the ATA Gateway to the domain controller and looks for that traffic on the Capture NIC on the domain controller.\nIf the ATA Gateway sees ICMP traffic with a destination IP address the same as the DC IP addressed you entered in the ATA Console, it deems port mirroring configured. \n\nSample for how to run the script:\n\n    # ATAdiag.ps1 -CaptureIP n.n.n.n -DCIP n.n.n.n -TestCount n\n    \n    param([parameter(Mandatory=$true)][string]$CaptureIP, [parameter(Mandatory=$true)][string]$DCIP, [int]$PingCount = 10)\n\n    # Set variables\n    \n        $ErrorActionPreference = \"stop\"\n    $starttime = get-date\n    $byteIn = new-object byte[] 4\n    $byteOut = new-object byte[] 4\n    $byteData = new-object byte[] 4096  # size of data\n    \n    $byteIn[0] = 1  # for promiscuous mode\n    $byteIn[1-3] = 0\n    $byteOut[0-3] = 0\n\n\n\n    # Convert network data to host format\n        function NetworkToHostUInt16 ($value)\n        {\n        [Array]::Reverse($value)\n        [BitConverter]::ToUInt16($value,0)\n        }\n    \n    function NetworkToHostUInt32 ($value)\n        {\n        [Array]::Reverse($value)\n        [BitConverter]::ToUInt32($value,0)\n        }\n    \n    function ByteToString ($value)\n        {\n        $AsciiEncoding = new-object system.text.asciiencoding\n        $AsciiEncoding.GetString($value)\n            }\n    \n    Write-Host \"Testing Port Mirroring...\" -ForegroundColor Yellow\n    Write-Host \"\"\n    Write-Host \"Here is a summary of the connection we will test.\" -ForegroundColor Yellow\n\n    # Initialize a first ping connection\n    Test-Connection -Count 1 -ComputerName $DCIP -ea SilentlyContinue\n    Write-Host \"\"\n    \n    Write-Host \"Press any key to continue...\" -ForegroundColor Red\n    [void][System.Console]::ReadKey($true)\n    Write-Host \"\"\n    Write-Host \"Sending ICMP and Capturing data...\" -ForegroundColor Yellow\n    \n    # Open a socket\n    \n    $socket = new-object system.net.sockets.socket([Net.Sockets.AddressFamily]::InterNetwork,[Net.Sockets.SocketType]::Raw,[Net.Sockets.ProtocolType]::IP)\n    \n    # Include the IP header\n    $socket.setsocketoption(\"IP\",\"HeaderIncluded\",$true)\n    \n    $socket.ReceiveBufferSize = 10000\n    \n    $ipendpoint = new-object system.net.ipendpoint([net.ipaddress]\"$CaptureIP\",0)\n    $socket.bind($ipendpoint)\n    \n    # Enable promiscuous mode\n    [void]$socket.iocontrol([net.sockets.iocontrolcode]::ReceiveAll,$byteIn,$byteOut)\n    \n    # Initialize test variables\n    $tests = 0\n    $TestResult = \"Noise\"\n    $OneSuccess = 0\n    \n    while ($tests -le $PingCount)\n        {\n        if (!$socket.Available)  # see if any packets are in the queue\n            {\n            start-sleep -milliseconds 500\n            continue\n            }\n    \n    # Capture traffic\n        $rcv = $socket.receive($byteData,0,$byteData.length,[net.sockets.socketflags]::None)\n    \n    # Decode the header so we can read ICMP\n    \n        $MemoryStream = new-object System.IO.MemoryStream($byteData,0,$rcv)\n        $BinaryReader = new-object System.IO.BinaryReader($MemoryStream)\n    \n    # Set IP version & header length\n        $VersionAndHeaderLength = $BinaryReader.ReadByte()\n    \n        # TOS\n        $TypeOfService= $BinaryReader.ReadByte()\n    \n        # More values, and the Protocol Number for ICMP traffic\n        # Convert network format of big-endian to host format of little-endian \n        $TotalLength = NetworkToHostUInt16 $BinaryReader.ReadBytes(2)\n    \n        $Identification = NetworkToHostUInt16 $BinaryReader.ReadBytes(2)\n        $FlagsAndOffset = NetworkToHostUInt16 $BinaryReader.ReadBytes(2)\n        $TTL = $BinaryReader.ReadByte()\n        $ProtocolNumber = $BinaryReader.ReadByte()\n        $Checksum = [Net.IPAddress]::NetworkToHostOrder($BinaryReader.ReadInt16())\n    \n        # The source and destination IP addresses\n        $SourceIPAddress = $BinaryReader.ReadUInt32()\n        $DestinationIPAddress = $BinaryReader.ReadUInt32()\n    \n        # The source and destimation ports\n        $sourcePort = [uint16]0\n        $destPort = [uint16]0\n            \n        # Close the stream reader\n        $BinaryReader.Close()\n        $memorystream.Close()\n    \n        # Cast DCIP into an IPaddress type\n        $DCIPP = [ipaddress] $DCIP\n        $DestinationIPAddressP = [ipaddress] $DestinationIPAddress\n    \n        #Ping the DC at the end after starting the capture\n        Test-Connection -Count 1 -ComputerName $DCIP -ea SilentlyContinue | Out-Null\n            \n        # This is the match logic - check to see if Destination IP from the Ping sent matches the DCIP entered by in the ATA Console  \n        # The only way the ATA Gateway should see a destination of the DC is if Port Spanning is configured\n        \n            if ($DestinationIPAddressP -eq $DCIPP)  # is the destination IP eq to the DC IP? \n            {\n            $TestResult = \"Port Spanning success!\"\n            $OneSuccess = 1\n            } else {\n                $TestResult = \"Noise\"\n            }\n        \n        # Put source, destination, test result in Powershell object\n        \n        new-object psobject | add-member -pass noteproperty CaptureSource $([system.net.ipaddress]$SourceIPAddress) | add-member -pass noteproperty CaptureDestination $([system.net.ipaddress]$DestinationIPAddress) | Add-Member -pass NoteProperty Result $TestResult | Format-List | Out-Host\n        #Count tests\n        $tests ++\n        }\n    \n        If ($OneSuccess -eq 1){\n            Write-Host \"Port Spanning Success!\" -ForegroundColor Green\n            Write-Host \"\"\n            Write-Host \"At least one packet which was addressed to the DC, was picked up by the Gateway.\" -ForegroundColor Yellow\n            Write-Host \"A little noise is OK, but if you don't see a majority of successes, you might want to re-run.\" -ForegroundColor Yellow\n        } Else {\n            Write-Host \"No joy, all noise.  You may want to re-run, increase the number of Ping Counts, or check your config.\" -ForegroundColor Red\n        }\n    \n    Write-Host \"\"\n    Write-Host \"Press any key to continue...\" -ForegroundColor Red\n    [void][System.Console]::ReadKey($true)\n    \n    \n## Validate port mirroring using Net Mon\n1.  Install [Microsoft Network Monitor 3.4](http://www.microsoft.com/download/details.aspx?id=4865) on the ATA Gateway that you want to validate..\n\n    > [!IMPORTANT]\n    > Do not install Microsoft Message Analyzer, or any other traffic capture software on the ATA Gateway.\n\n2.  Open Network Monitor and create a new capture tab.\n\n    1.  Select only the **Capture** network adapter or the network adapter that is connected to the switch port that is configured as the port mirroring destination.\n\n    2.  Ensure that P-Mode is enabled.\n\n    3.  Click **New Capture**.\n\n        ![Create new capture tab image](media/ATA-Port-Mirroring-Capture.jpg)\n\n3.  In the Display Filter window, enter the following filter: **KerberosV5 OR LDAP** and then click **Apply**.\n\n    ![Apply KerberosV5 or LDAP filter image](media/ATA-Port-Mirroring-filter-settings.jpg)\n\n4.  Click **Start** to start the capture session. If you do not see traffic to and from the domain controller, review your port mirroring configuration.\n\n    ![Start capture session image](media/ATA-Port-Mirroring-Capture-traffic.jpg)\n\n    > [!NOTE]\n    > It is important to make sure you see traffic to and from the domain controllers.\n    \n\n5.  If you only see traffic in one direction, you should work with your networking or virtualization teams to help troubleshoot your port mirroring configuration.\n\n## See Also\n\n- [Configure port mirroring](configure-port-mirroring.md)\n- [Check out the ATA forum!](https://social.technet.microsoft.com/Forums/security/home?forum=mata)\n"}