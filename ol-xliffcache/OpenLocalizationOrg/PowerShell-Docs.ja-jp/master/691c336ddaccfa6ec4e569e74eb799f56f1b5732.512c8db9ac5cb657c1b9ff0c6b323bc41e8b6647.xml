{"nodes":[{"pos":[32,74],"content":"Configure Event Collection | Microsoft ATA","needQuote":true,"nodes":[{"content":"Configure Event Collection | Microsoft ATA","pos":[0,42]}]},{"pos":[88,152],"content":"Describes your options for configuring event collection with ATA","needQuote":true,"nodes":[{"content":"Describes your options for configuring event collection with ATA","pos":[0,64]}]},{"pos":[481,540],"content":"<bpt id=\"p1\">*</bpt>Applies to: Advanced Threat Analytics version 1.6 and 1.7<ept id=\"p1\">*</ept>","source":"*Applies to: Advanced Threat Analytics version 1.6 and 1.7*"},{"content":"Configure Event Collection","pos":[546,572]},{"content":"To enhance detection capabilities, ATA needs Windows Event log ID 4776.","pos":[573,644]},{"content":"This can be forwarded to the ATA Gateway in one of two ways, by configuring the ATA Gateway to listen for SIEM events or by <bpt id=\"p1\">[</bpt>Configuring Windows Event Forwarding<ept id=\"p1\">](#configuring-windows-event-forwarding)</ept>.","pos":[645,847],"source":" This can be forwarded to the ATA Gateway in one of two ways, by configuring the ATA Gateway to listen for SIEM events or by [Configuring Windows Event Forwarding](#configuring-windows-event-forwarding)."},{"content":"Event collection","pos":[852,868]},{"content":"In addition to collecting and analyzing network traffic to and from the domain controllers, ATA can use Windows event 4776 to further enhance ATA Pass-the-Hash detection.","pos":[869,1039]},{"content":"This can be received from your SIEM or by  setting Windows Event Forwarding from your domain controller.","pos":[1040,1144]},{"content":"Events collected provide ATA with additional information that is not available via the domain controller network traffic.","pos":[1145,1266]},{"content":"SIEM/Syslog","pos":[1272,1283]},{"content":"For ATA to be able to consume data from a Syslog server, you need to do the following:","pos":[1284,1370]},{"content":"Configure your ATA Gateway servers to listen to and accept events forwarded from the SIEM/Syslog server.","pos":[1376,1480]},{"content":"Configure your SIEM/Syslog server to forward specific events to the ATA Gateway.","pos":[1486,1566]},{"content":"Do not forward all the Syslog data to the ATA Gateway.","pos":[1589,1643]},{"content":"ATA supports UDP traffic from the SIEM/Syslog server.","pos":[1650,1703]},{"content":"Refer to your SIEM/Syslog server's product documentation for information on how to configure forwarding of specific events to another server.","pos":[1705,1846]},{"content":"Windows event forwarding","pos":[1853,1877]},{"content":"If you do not use a SIEM/Syslog server, you can configure your Windows domain controllers to forward Windows Event ID 4776 to be collected and analyzed by ATA.","pos":[1878,2037]},{"content":"Windows Event ID 4776 provides data regarding NTLM authentications.","pos":[2038,2105]},{"content":"Configuring the ATA Gateway to listen for SIEM events","pos":[2110,2163]},{"pos":[2169,2251],"content":"On the ATA configuration, under \"Events\" tab enable <bpt id=\"p1\">**</bpt>Syslog<ept id=\"p1\">**</ept> and press <bpt id=\"p2\">**</bpt>Save<ept id=\"p2\">**</ept>.","source":"On the ATA configuration, under \"Events\" tab enable **Syslog** and press **Save**."},{"content":"Enable syslog listener UDP image","pos":[2259,2291]},{"content":"Configure your SIEM or Syslog server to forward Windows Event ID 4776 to the IP address of one of the ATA Gateways.","pos":[2340,2455]},{"content":"For additional information on configuring your SIEM, refer to your SIEM online help or technical support options for specific formatting requirements for each SIEM server.","pos":[2456,2627]},{"content":"SIEM support","pos":[2633,2645]},{"content":"ATA supports SIEM events in the following formats:","pos":[2646,2696]},{"content":"RSA Security Analytics","pos":[2703,2725]},{"content":"<ph id=\"ph1\">&amp;lt;</ph>Syslog Header<ph id=\"ph2\">&amp;gt;</ph>RsaSA\\n2015-May-19 09:07:09\\n4776\\nMicrosoft-Windows-Security-Auditing\\nSecurity\\XXXXX.subDomain.domain.org.il\\nYYYYY$\\nMMMMM \\n0x0","pos":[2726,2878],"source":"&lt;Syslog Header&gt;RsaSA\\n2015-May-19 09:07:09\\n4776\\nMicrosoft-Windows-Security-Auditing\\nSecurity\\XXXXX.subDomain.domain.org.il\\nYYYYY$\\nMMMMM \\n0x0"},{"content":"Syslog header is optional.","pos":[2884,2910]},{"content":"“\\n” character separator is required between all fields.","pos":[2916,2972]},{"content":"The fields, in order, are:","pos":[2978,3004]},{"content":"RsaSA constant (must appear).","pos":[3014,3043]},{"content":"The timestamp of the actual event (make sure it’s not the timestamp of the arrival to the SIEM or when it’s sent to ATA).","pos":[3053,3174]},{"content":"Preferably  in milliseconds accuracy, this is very important.","pos":[3175,3236]},{"content":"The windows event ID","pos":[3246,3266]},{"content":"The windows event provider name","pos":[3276,3307]},{"content":"The windows event log name","pos":[3317,3343]},{"content":"The name of the computer receiving the event (the DC in this case)","pos":[3353,3419]},{"content":"The name of the user authenticating","pos":[3429,3464]},{"content":"The name of the source host name","pos":[3474,3506]},{"content":"The result code of the NTLM","pos":[3515,3542]},{"content":"The order is important and nothing else should be included in the message.","pos":[3548,3622]},{"content":"HP Arcsight","pos":[3629,3640]},{"content":"CEF:0|Microsoft|Microsoft Windows||Microsoft-Windows-Security-Auditing:4776|The domain controller attempted to validate the credentials for an account.|Low| externalId=4776 cat=Security rt=1426218619000 shost=KKKKKK dhost=YYYYYY.subDomain.domain.com duser=XXXXXX cs2=Security cs3=Microsoft-Windows-Security-Auditing cs4=0x0 cs3Label=EventSource cs4Label=Reason or Error Code","pos":[3641,4015]},{"content":"Must comply with the protocol definition.","pos":[4021,4062]},{"content":"No syslog header.","pos":[4068,4085]},{"content":"The header part (the part that’s separated by a pipe) must exist (as stated in the protocol).","pos":[4091,4184]},{"pos":[4190,4262],"content":"The following keys in the <bpt id=\"p1\">_</bpt>Extension<ept id=\"p1\">_</ept> part must be present in the event:","source":"The following keys in the _Extension_ part must be present in the event:"},{"content":"externalId = the Windows event ID","pos":[4272,4305]},{"content":"rt = the timestamp of the actual event (make sure it’s not the timestamp of the arrival to the SIEM or when it’s sent to us).","pos":[4315,4440]},{"content":"Preferably  in milliseconds accuracy, this is very important.","pos":[4441,4502]},{"content":"cat = the Windows event log name","pos":[4512,4544]},{"content":"shost = the source host name","pos":[4554,4582]},{"content":"dhost = the computer receiving the event (the DC in this case)","pos":[4592,4654]},{"content":"duser = the user authenticating","pos":[4664,4695]},{"pos":[4701,4752],"content":"The order is not important for the <bpt id=\"p1\">_</bpt>Extension<ept id=\"p1\">_</ept> part","source":"The order is not important for the _Extension_ part"},{"content":"There must be a custom key and keyLable for these two fields:","pos":[4758,4819]},{"content":"“EventSource”","pos":[4829,4842]},{"content":"“Reason or Error Code” = The result code of the NTLM","pos":[4852,4904]},{"content":"Splunk","pos":[4911,4917]},{"content":"<ph id=\"ph1\">&amp;lt;</ph>Syslog Header<ph id=\"ph2\">&amp;gt;</ph>\\r\\nEventCode=4776\\r\\nLogfile=Security\\r\\nSourceName=Microsoft-Windows-Security-Auditing\\r\\nTimeGenerated=20150310132717.784882-000\\r\\ComputerName=YYYYY\\r\\nMessage=","pos":[4918,5103],"source":"&lt;Syslog Header&gt;\\r\\nEventCode=4776\\r\\nLogfile=Security\\r\\nSourceName=Microsoft-Windows-Security-Auditing\\r\\nTimeGenerated=20150310132717.784882-000\\r\\ComputerName=YYYYY\\r\\nMessage="},{"content":"The computer attempted to validate the credentials for an account.","pos":[5105,5171]},{"content":"Authentication Package:              MICROSOFT_AUTHENTICATION_PACKAGE_V1_0","pos":[5173,5247]},{"content":"Logon Account: Administrator","pos":[5249,5277]},{"content":"Source Workstation:       SIEM","pos":[5279,5309]},{"content":"Error Code:         0x0","pos":[5311,5334]},{"content":"Syslog header is optional.","pos":[5340,5366]},{"content":"There’s a “\\r\\n” character separator between all required fields.","pos":[5372,5437]},{"content":"The fields are in key=value format.","pos":[5443,5478]},{"content":"The following keys must exists and have a value:","pos":[5484,5532]},{"content":"EventCode = the Windows event ID","pos":[5542,5574]},{"content":"Logfile = the Windows event log name","pos":[5584,5620]},{"content":"SourceName = The Windows event provider name","pos":[5630,5674]},{"content":"TimeGenerated = the timestamp of the actual event (make sure it’s not the timestamp of the arrival to the SIEM or when it’s sent to ATA).","pos":[5684,5821]},{"content":"The format should match yyyyMMddHHmmss.FFFFFF, preferably  in milliseconds accuracy, this is very important.","pos":[5822,5930]},{"content":"ComputerName = the source host name","pos":[5940,5975]},{"content":"Message = the original event text from the Windows event","pos":[5985,6041]},{"content":"The Message Key and value MUST be last.","pos":[6047,6086]},{"content":"The order is not important for the key=value pairs.","pos":[6092,6143]},{"content":"QRadar","pos":[6150,6156]},{"content":"QRadar enables event collection via an agent.","pos":[6157,6202]},{"content":"If the data is gathered using an agent, the time format is gathered without millisecond data.","pos":[6203,6296]},{"content":"Because ATA necessitates millisecond data, it is necessary to set QRadar to use agentless Windows event collection.","pos":[6297,6412]},{"content":"For more information, see <bpt id=\"p1\">[</bpt>http://www-01.ibm.com/support/docview.wss?uid=swg21700170<ept id=\"p1\">]</ept><bpt id=\"p2\">(http://www-01.ibm.com/support/docview.wss?uid=swg21700170 \"</bpt>QRadar: Agentless Windows Events Collection using the MSRPC Protocol<ept id=\"p2\">\")</ept>.","pos":[6413,6629],"source":" For more information, see [http://www-01.ibm.com/support/docview.wss?uid=swg21700170](http://www-01.ibm.com/support/docview.wss?uid=swg21700170 \"QRadar: Agentless Windows Events Collection using the MSRPC Protocol\")."},{"content":"The fields needed are:","pos":[7134,7156]},{"content":"The agent type for the collection","pos":[7160,7193]},{"content":"The windows event log provider name","pos":[7196,7231]},{"content":"The windows event log source","pos":[7234,7262]},{"content":"The DC fully qualified domain name","pos":[7265,7299]},{"content":"The windows event ID","pos":[7302,7322]},{"content":"TimeGenerated is the timestamp of the actual event (make sure it’s not the timestamp of the arrival to the SIEM or when it’s sent to ATA).","pos":[7324,7462]},{"content":"The format should match yyyyMMddHHmmss.FFFFFF, preferably in milliseconds accuracy, this is very important.","pos":[7463,7570]},{"content":"Message is the original event text from the Windows event","pos":[7572,7629]},{"content":"Make sure to have \\t between the key=value pairs.","pos":[7631,7680]},{"pos":[7683,7757],"content":"[!NOTE] \nUsing WinCollect for Windows event collection is not supported.","leadings":["","> "],"nodes":[{"content":"Using WinCollect for Windows event collection is not supported.","pos":[9,72]}]},{"content":"Configuring Windows Event Forwarding","pos":[7762,7798]},{"content":"WEF configuration for ATA Gateway's with port mirroring","pos":[7804,7859]},{"content":"After you configured port mirroring from the domain controllers to the ATA Gateway, follow the instructions below to configure Windows Event forwarding using Source Initiated configuration.","pos":[7861,8050]},{"content":"This is one way to configure Windows Event forwarding.","pos":[8051,8105]},{"pos":[8108,8190],"content":"<bpt id=\"p1\">**</bpt>Step 1: Add the network service account to the domain Event Log Readers Group.<ept id=\"p1\">**</ept>","source":"**Step 1: Add the network service account to the domain Event Log Readers Group.**"},{"content":"In this scenario we are assuming that the ATA Gateway is a member of the domain.","pos":[8193,8273]},{"pos":[8279,8396],"content":"Open Active Directory Users and Computers, navigate to the <bpt id=\"p1\">**</bpt>BuiltIn<ept id=\"p1\">**</ept> folder and double click <bpt id=\"p2\">**</bpt>Event Log Readers<ept id=\"p2\">**</ept>.","source":"Open Active Directory Users and Computers, navigate to the **BuiltIn** folder and double click **Event Log Readers**."},{"pos":[8402,8421],"content":"Select <bpt id=\"p1\">**</bpt>Members<ept id=\"p1\">**</ept>.","source":"Select **Members**."},{"content":"If <bpt id=\"p1\">**</bpt>Network Service<ept id=\"p1\">**</ept> is not listed, click <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept>, type <bpt id=\"p3\">**</bpt>Network Service<ept id=\"p3\">**</ept> in the <bpt id=\"p4\">**</bpt>Enter the object names to select<ept id=\"p4\">**</ept> field.","pos":[8426,8554],"source":"If **Network Service** is not listed, click **Add**, type **Network Service** in the **Enter the object names to select** field."},{"content":"Then click <bpt id=\"p1\">**</bpt>Check Names<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept> twice.","pos":[8555,8605],"source":" Then click **Check Names** and click **OK** twice."},{"pos":[8608,8719],"content":"<bpt id=\"p1\">**</bpt>Step 2: Create a policy on the domain controllers to set the Configure target Subscription Manager setting.<ept id=\"p1\">**</ept>","source":"**Step 2: Create a policy on the domain controllers to set the Configure target Subscription Manager setting.**"},{"pos":[8723,8931],"content":"[!Note] \nYou can create a group policy for these settings and apply the group policy to each domain controller monitored by the ATA Gateway. The steps below modify the local policy of the domain controller.","leadings":["","> "],"nodes":[{"content":"You can create a group policy for these settings and apply the group policy to each domain controller monitored by the ATA Gateway. The steps below modify the local policy of the domain controller.","pos":[9,206],"nodes":[{"content":"You can create a group policy for these settings and apply the group policy to each domain controller monitored by the ATA Gateway.","pos":[0,131]},{"content":"The steps below modify the local policy of the domain controller.","pos":[132,197]}]}]},{"pos":[8942,9014],"content":"Run the following command on each domain controller: <bpt id=\"p1\">*</bpt>winrm quickconfig<ept id=\"p1\">*</ept>","source":"Run the following command on each domain controller: *winrm quickconfig*"},{"pos":[9019,9059],"content":"From a command prompt type <bpt id=\"p1\">*</bpt>gpedit.msc<ept id=\"p1\">*</ept>.","source":"From a command prompt type *gpedit.msc*."},{"pos":[9064,9164],"content":"Expand <bpt id=\"p1\">**</bpt>Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Event Forwarding<ept id=\"p1\">**</ept>","source":"Expand **Computer Configuration > Administrative Templates > Windows Components > Event Forwarding**"},{"content":"Local policy group editor image","pos":[9169,9200]},{"pos":[9250,9305],"content":"Double click <bpt id=\"p1\">**</bpt>Configure target Subscription Manager<ept id=\"p1\">**</ept>.","source":"Double click **Configure target Subscription Manager**."},{"pos":[9318,9337],"content":"Select <bpt id=\"p1\">**</bpt>Enabled<ept id=\"p1\">**</ept>.","source":"Select **Enabled**."},{"pos":[9346,9379],"content":"Under <bpt id=\"p1\">**</bpt>Options<ept id=\"p1\">**</ept> click <bpt id=\"p2\">**</bpt>Show<ept id=\"p2\">**</ept>.","source":"Under **Options** click **Show**."},{"pos":[9388,9641],"content":"Under <bpt id=\"p1\">**</bpt>SubscriptionManagers<ept id=\"p1\">**</ept> enter the following value and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>:  <bpt id=\"p3\">*</bpt>Server=http://<ph id=\"ph1\">&lt;fqdnATAGateway&gt;</ph>:5985/wsman/SubscriptionManager/WEC,Refresh=10<ept id=\"p3\">*</ept> (For example: Server=http://atagateway9.contoso.com:5985/wsman/SubscriptionManager/WEC,Refresh=10)","source":"Under **SubscriptionManagers** enter the following value and click **OK**:  *Server=http://<fqdnATAGateway>:5985/wsman/SubscriptionManager/WEC,Refresh=10* (For example: Server=http://atagateway9.contoso.com:5985/wsman/SubscriptionManager/WEC,Refresh=10)"},{"content":"Configure target subscription image","pos":[9649,9684]},{"pos":[9741,9754],"content":"Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.","source":"Click **OK**."},{"pos":[9763,9818],"content":"From an elevated command prompt type <bpt id=\"p1\">*</bpt>gpupdate /force<ept id=\"p1\">*</ept>.","source":"From an elevated command prompt type *gpupdate /force*."},{"pos":[9821,9879],"content":"<bpt id=\"p1\">**</bpt>Step 3: Perform the following steps on the ATA Gateway<ept id=\"p1\">**</ept>","source":"**Step 3: Perform the following steps on the ATA Gateway**"},{"pos":[9886,9939],"content":"Open an elevated command prompt and type <bpt id=\"p1\">*</bpt>wecutil qc<ept id=\"p1\">*</ept>","source":"Open an elevated command prompt and type *wecutil qc*"},{"pos":[9944,9966],"content":"Open <bpt id=\"p1\">**</bpt>Event Viewer<ept id=\"p1\">**</ept>.","source":"Open **Event Viewer**."},{"pos":[9972,10037],"content":"Right click <bpt id=\"p1\">**</bpt>Subscriptions<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Create Subscription<ept id=\"p2\">**</ept>.","source":"Right click **Subscriptions** and select **Create Subscription**."},{"content":"Enter a name and description for the subscription.","pos":[10048,10098]},{"content":"For <bpt id=\"p1\">**</bpt>Destination Log<ept id=\"p1\">**</ept> confirm that <bpt id=\"p2\">**</bpt>Forwarded Events<ept id=\"p2\">**</ept> is selected.","pos":[10108,10178],"source":"For **Destination Log** confirm that **Forwarded Events** is selected."},{"content":"For ATA to read the events, the destination log must be <bpt id=\"p1\">**</bpt>Forwarded Events<ept id=\"p1\">**</ept>.","pos":[10179,10256],"source":" For ATA to read the events, the destination log must be **Forwarded Events**."},{"pos":[10266,10341],"content":"Select <bpt id=\"p1\">**</bpt>Source computer initiated<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>Select Computers Groups<ept id=\"p2\">**</ept>.","source":"Select **Source computer initiated** and click **Select Computers Groups**."},{"pos":[10354,10384],"content":"Click <bpt id=\"p1\">**</bpt>Add Domain Computer<ept id=\"p1\">**</ept>.","source":"Click **Add Domain Computer**."},{"content":"Enter the name of the domain controller in the <bpt id=\"p1\">**</bpt>Enter the object name to select<ept id=\"p1\">**</ept> field.","pos":[10397,10486],"source":"Enter the name of the domain controller in the **Enter the object name to select** field."},{"content":"Then click <bpt id=\"p1\">**</bpt>Check Names<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.","pos":[10487,10531],"source":" Then click **Check Names** and click **OK**."},{"content":"Event Viewer image","pos":[10551,10569]},{"pos":[10625,10638],"content":"Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.","source":"Click **OK**."},{"pos":[10647,10671],"content":"Click <bpt id=\"p1\">**</bpt>Select Events<ept id=\"p1\">**</ept>.","source":"Click **Select Events**."},{"pos":[10684,10725],"content":"Click <bpt id=\"p1\">**</bpt>By log<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Security<ept id=\"p2\">**</ept>.","source":"Click **By log** and select **Security**."},{"pos":[10737,10812],"content":"In the <bpt id=\"p1\">**</bpt>Includes/Excludes Event ID<ept id=\"p1\">**</ept> field type <bpt id=\"p2\">**</bpt>4776<ept id=\"p2\">**</ept> and click <bpt id=\"p3\">**</bpt>OK<ept id=\"p3\">**</ept>.","source":"In the **Includes/Excludes Event ID** field type **4776** and click **OK**."},{"content":"Query filter image","pos":[10818,10836]},{"pos":[10877,10991],"content":"Right click the created subscription and select <bpt id=\"p1\">**</bpt>Runtime Status<ept id=\"p1\">**</ept> to see if there are any issues with the status.","source":"Right click the created subscription and select **Runtime Status** to see if there are any issues with the status."},{"content":"After a few minutes, check to see that event 4776 is showing up in the Forwarded Events on the ATA Gateway.","pos":[11001,11108]},{"content":"WEF configuration for the ATA Lightweight Gateway","pos":[11115,11164]},{"content":"When you install the ATA Lightweight Gateway on your domain controllers, you can set up your domain controllers to forward the events to itself.","pos":[11165,11309]},{"content":"Perform the following steps to configure the Window Event Forwarding when using the ATA Lightweight Gateway.","pos":[11310,11419],"source":" \nPerform the following steps to configure the Window Event Forwarding when using the ATA Lightweight Gateway."},{"content":"This is one way to configure Windows Event forwarding.","pos":[11420,11474]},{"pos":[11478,11559],"content":"<bpt id=\"p1\">**</bpt>Step 1: Add the network service account to the domain Event Log Readers Group<ept id=\"p1\">**</ept>","source":"**Step 1: Add the network service account to the domain Event Log Readers Group**"},{"pos":[11566,11682],"content":"Open Active Directory Users and Computer, navigate to the <bpt id=\"p1\">**</bpt>BuiltIn<ept id=\"p1\">**</ept> folder and double click <bpt id=\"p2\">**</bpt>Event Log Readers<ept id=\"p2\">**</ept>.","source":"Open Active Directory Users and Computer, navigate to the **BuiltIn** folder and double click **Event Log Readers**."},{"pos":[11688,11707],"content":"Select <bpt id=\"p1\">**</bpt>Members<ept id=\"p1\">**</ept>.","source":"Select **Members**."},{"content":"If <bpt id=\"p1\">**</bpt>Network Service<ept id=\"p1\">**</ept> is not listed, click <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept> and type <bpt id=\"p3\">**</bpt>Network Service<ept id=\"p3\">**</ept> in the <bpt id=\"p4\">**</bpt>Enter the object names to select<ept id=\"p4\">**</ept> field.","pos":[11712,11843],"source":"If **Network Service** is not listed, click **Add** and type **Network Service** in the **Enter the object names to select** field."},{"content":"Then click <bpt id=\"p1\">**</bpt>Check Names<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept> twice.","pos":[11844,11894],"source":" Then click **Check Names** and click **OK** twice."},{"pos":[11897,12008],"content":"<bpt id=\"p1\">**</bpt>Step 2: Perform the following steps on the domain controller after the ATA Lightweight Gateway is installed<ept id=\"p1\">**</ept>","source":"**Step 2: Perform the following steps on the domain controller after the ATA Lightweight Gateway is installed**"},{"pos":[12015,12092],"content":"Open an elevated command prompt and type <bpt id=\"p1\">*</bpt>winrm quickconfig<ept id=\"p1\">*</ept> and <bpt id=\"p2\">*</bpt>wecutil qc<ept id=\"p2\">*</ept>","source":"Open an elevated command prompt and type *winrm quickconfig* and *wecutil qc*"},{"pos":[12098,12120],"content":"Open <bpt id=\"p1\">**</bpt>Event Viewer<ept id=\"p1\">**</ept>.","source":"Open **Event Viewer**."},{"pos":[12126,12191],"content":"Right click <bpt id=\"p1\">**</bpt>Subscriptions<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Create Subscription<ept id=\"p2\">**</ept>.","source":"Right click **Subscriptions** and select **Create Subscription**."},{"content":"Enter a name and description for the subscription.","pos":[12202,12252]},{"content":"For <bpt id=\"p1\">**</bpt>Destination Log<ept id=\"p1\">**</ept> confirm that <bpt id=\"p2\">**</bpt>Forwarded Events<ept id=\"p2\">**</ept> is selected.","pos":[12262,12332],"source":"For **Destination Log** confirm that **Forwarded Events** is selected."},{"content":"For ATA to read the events the destination log must be Forwarded Events.","pos":[12333,12405]},{"content":"Select <bpt id=\"p1\">**</bpt>Collector initiated<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>Select Computers<ept id=\"p2\">**</ept>.","pos":[12419,12481],"source":"Select **Collector initiated** and click **Select Computers**."},{"content":"Then click <bpt id=\"p1\">**</bpt>Add Domain Computer<ept id=\"p1\">**</ept>.","pos":[12482,12517],"source":" Then click **Add Domain Computer**."},{"content":"Enter the name of the domain controller in the <bpt id=\"p1\">**</bpt>Enter the object name to select<ept id=\"p1\">**</ept>.","pos":[12530,12613],"source":"Enter the name of the domain controller in the **Enter the object name to select**."},{"content":"Then click <bpt id=\"p1\">**</bpt>Check Names<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.","pos":[12614,12658],"source":" Then click **Check Names** and click **OK**."},{"content":"Subscription properties image","pos":[12674,12703]},{"pos":[12760,12773],"content":"Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>.","source":"Click **OK**."},{"pos":[12782,12806],"content":"Click <bpt id=\"p1\">**</bpt>Select Events<ept id=\"p1\">**</ept>.","source":"Click **Select Events**."},{"pos":[12820,12861],"content":"Click <bpt id=\"p1\">**</bpt>By log<ept id=\"p1\">**</ept> and select <bpt id=\"p2\">**</bpt>Security<ept id=\"p2\">**</ept>.","source":"Click **By log** and select **Security**."},{"pos":[12874,12941],"content":"In the <bpt id=\"p1\">**</bpt>Includes/Excludes Event ID<ept id=\"p1\">**</ept> type <bpt id=\"p2\">*</bpt>4776<ept id=\"p2\">*</ept> and click <bpt id=\"p3\">**</bpt>OK<ept id=\"p3\">**</ept>.","source":"In the **Includes/Excludes Event ID** type *4776* and click **OK**."},{"content":"Query filter image","pos":[12946,12964]},{"pos":[13006,13120],"content":"Right click the created subscription and select <bpt id=\"p1\">**</bpt>Runtime Status<ept id=\"p1\">**</ept> to see if there are any issues with the status.","source":"Right click the created subscription and select **Runtime Status** to see if there are any issues with the status."},{"pos":[13125,13212],"content":"[!Note] \nYou may need to reboot the domain controller before the setting take effect.","leadings":["","> "],"nodes":[{"content":"You may need to reboot the domain controller before the setting take effect.","pos":[9,85]}]},{"content":"After a few minutes, check to see that event 4776 is showing up in the Forwarded Events on the ATA Gateway.","pos":[13215,13322]},{"pos":[13326,13455],"content":"For more information see: <bpt id=\"p1\">[</bpt>Configure the computers to forward and collect events<ept id=\"p1\">](https://technet.microsoft.com/library/cc748890)</ept>","source":"For more information see: [Configure the computers to forward and collect events](https://technet.microsoft.com/library/cc748890)"},{"content":"See Also","pos":[13460,13468]},{"pos":[13471,13500],"content":"<bpt id=\"p1\">[</bpt>Install ATA<ept id=\"p1\">](install-ata.md)</ept>","source":"[Install ATA](install-ata.md)"},{"pos":[13503,13606],"content":"<bpt id=\"p1\">[</bpt>Check out the ATA forum!!<ept id=\"p1\">](https://social.technet.microsoft.com/Forums/security/en-US/home?forum=mata)</ept>","source":"[Check out the ATA forum!!](https://social.technet.microsoft.com/Forums/security/en-US/home?forum=mata)"}],"content":"---\n# required metadata\n\ntitle: Configure Event Collection | Microsoft ATA\ndescription: Describes your options for configuring event collection with ATA\nkeywords:\nauthor: rkarlin\nmanager: mbaldwin\nms.date: 04/28/2016\nms.topic: get-started-article\nms.prod:\nms.service: advanced-threat-analytics\nms.technology:\nms.assetid: 3f0498f9-061d-40e6-ae07-98b8dcad9b20\n\n# optional metadata\n\n#ROBOTS:\n#audience:\n#ms.devlang:\nms.reviewer: bennyl\nms.suite: ems\n#ms.tgt_pltfrm:\n#ms.custom:\n\n---\n\n*Applies to: Advanced Threat Analytics version 1.6 and 1.7*\n\n\n\n# Configure Event Collection\nTo enhance detection capabilities, ATA needs Windows Event log ID 4776. This can be forwarded to the ATA Gateway in one of two ways, by configuring the ATA Gateway to listen for SIEM events or by [Configuring Windows Event Forwarding](#configuring-windows-event-forwarding).\n\n## Event collection\nIn addition to collecting and analyzing network traffic to and from the domain controllers, ATA can use Windows event 4776 to further enhance ATA Pass-the-Hash detection. This can be received from your SIEM or by  setting Windows Event Forwarding from your domain controller. Events collected provide ATA with additional information that is not available via the domain controller network traffic.\n\n### SIEM/Syslog\nFor ATA to be able to consume data from a Syslog server, you need to do the following:\n\n-   Configure your ATA Gateway servers to listen to and accept events forwarded from the SIEM/Syslog server.\n\n-   Configure your SIEM/Syslog server to forward specific events to the ATA Gateway.\n\n> [!IMPORTANT]\n> -   Do not forward all the Syslog data to the ATA Gateway.\n> -   ATA supports UDP traffic from the SIEM/Syslog server.\n\nRefer to your SIEM/Syslog server's product documentation for information on how to configure forwarding of specific events to another server. \n\n### Windows event forwarding\nIf you do not use a SIEM/Syslog server, you can configure your Windows domain controllers to forward Windows Event ID 4776 to be collected and analyzed by ATA. Windows Event ID 4776 provides data regarding NTLM authentications.\n\n## Configuring the ATA Gateway to listen for SIEM events\n\n1.  On the ATA configuration, under \"Events\" tab enable **Syslog** and press **Save**.\n\n    ![Enable syslog listener UDP image](media/ATA-enable-siem-forward-events.png)\n\n2.  Configure your SIEM or Syslog server to forward Windows Event ID 4776 to the IP address of one of the ATA Gateways. For additional information on configuring your SIEM, refer to your SIEM online help or technical support options for specific formatting requirements for each SIEM server.\n\n### SIEM support\nATA supports SIEM events in the following formats:\n\n#### RSA Security Analytics\n&lt;Syslog Header&gt;RsaSA\\n2015-May-19 09:07:09\\n4776\\nMicrosoft-Windows-Security-Auditing\\nSecurity\\XXXXX.subDomain.domain.org.il\\nYYYYY$\\nMMMMM \\n0x0\n\n-   Syslog header is optional.\n\n-   “\\n” character separator is required between all fields.\n\n-   The fields, in order, are:\n\n    1.  RsaSA constant (must appear).\n\n    2.  The timestamp of the actual event (make sure it’s not the timestamp of the arrival to the SIEM or when it’s sent to ATA). Preferably  in milliseconds accuracy, this is very important.\n\n    3.  The windows event ID\n\n    4.  The windows event provider name\n\n    5.  The windows event log name\n\n    6.  The name of the computer receiving the event (the DC in this case)\n\n    7.  The name of the user authenticating\n\n    8.  The name of the source host name\n\n    9. The result code of the NTLM\n\n-   The order is important and nothing else should be included in the message.\n\n#### HP Arcsight\nCEF:0|Microsoft|Microsoft Windows||Microsoft-Windows-Security-Auditing:4776|The domain controller attempted to validate the credentials for an account.|Low| externalId=4776 cat=Security rt=1426218619000 shost=KKKKKK dhost=YYYYYY.subDomain.domain.com duser=XXXXXX cs2=Security cs3=Microsoft-Windows-Security-Auditing cs4=0x0 cs3Label=EventSource cs4Label=Reason or Error Code\n\n-   Must comply with the protocol definition.\n\n-   No syslog header.\n\n-   The header part (the part that’s separated by a pipe) must exist (as stated in the protocol).\n\n-   The following keys in the _Extension_ part must be present in the event:\n\n    -   externalId = the Windows event ID\n\n    -   rt = the timestamp of the actual event (make sure it’s not the timestamp of the arrival to the SIEM or when it’s sent to us). Preferably  in milliseconds accuracy, this is very important.\n\n    -   cat = the Windows event log name\n\n    -   shost = the source host name\n\n    -   dhost = the computer receiving the event (the DC in this case)\n\n    -   duser = the user authenticating\n\n-   The order is not important for the _Extension_ part\n\n-   There must be a custom key and keyLable for these two fields:\n\n    -   “EventSource”\n\n    -   “Reason or Error Code” = The result code of the NTLM\n\n#### Splunk\n&lt;Syslog Header&gt;\\r\\nEventCode=4776\\r\\nLogfile=Security\\r\\nSourceName=Microsoft-Windows-Security-Auditing\\r\\nTimeGenerated=20150310132717.784882-000\\r\\ComputerName=YYYYY\\r\\nMessage=\n\nThe computer attempted to validate the credentials for an account.\n\nAuthentication Package:              MICROSOFT_AUTHENTICATION_PACKAGE_V1_0\n\nLogon Account: Administrator\n\nSource Workstation:       SIEM\n\nError Code:         0x0\n\n-   Syslog header is optional.\n\n-   There’s a “\\r\\n” character separator between all required fields.\n\n-   The fields are in key=value format.\n\n-   The following keys must exists and have a value:\n\n    -   EventCode = the Windows event ID\n\n    -   Logfile = the Windows event log name\n\n    -   SourceName = The Windows event provider name\n\n    -   TimeGenerated = the timestamp of the actual event (make sure it’s not the timestamp of the arrival to the SIEM or when it’s sent to ATA). The format should match yyyyMMddHHmmss.FFFFFF, preferably  in milliseconds accuracy, this is very important.\n\n    -   ComputerName = the source host name\n\n    -   Message = the original event text from the Windows event\n\n-   The Message Key and value MUST be last.\n\n-   The order is not important for the key=value pairs.\n\n#### QRadar\nQRadar enables event collection via an agent. If the data is gathered using an agent, the time format is gathered without millisecond data. Because ATA necessitates millisecond data, it is necessary to set QRadar to use agentless Windows event collection. For more information, see [http://www-01.ibm.com/support/docview.wss?uid=swg21700170](http://www-01.ibm.com/support/docview.wss?uid=swg21700170 \"QRadar: Agentless Windows Events Collection using the MSRPC Protocol\").\n\n    <13>Feb 11 00:00:00 %IPADDRESS% AgentDevice=WindowsLog AgentLogFile=Security Source=Microsoft-Windows-Security-Auditing Computer=%FQDN% User= Domain= EventID=4776 EventIDCode=4776 EventType=8 EventCategory=14336 RecordNumber=1961417 TimeGenerated=1456144380009 TimeWritten=1456144380009 Message=The computer attempted to validate the credentials for an account. Authentication Package: MICROSOFT_AUTHENTICATION_PACKAGE_V1_0 Logon Account: Administrator Source Workstation: HOSTNAME Error Code: 0x0\n\nThe fields needed are:\n\n- The agent type for the collection\n- The windows event log provider name\n- The windows event log source\n- The DC fully qualified domain name\n- The windows event ID\n\nTimeGenerated is the timestamp of the actual event (make sure it’s not the timestamp of the arrival to the SIEM or when it’s sent to ATA). The format should match yyyyMMddHHmmss.FFFFFF, preferably in milliseconds accuracy, this is very important.\n\nMessage is the original event text from the Windows event\n\nMake sure to have \\t between the key=value pairs.\n\n>[!NOTE] \n> Using WinCollect for Windows event collection is not supported.\n\n## Configuring Windows Event Forwarding\n\n### WEF configuration for ATA Gateway's with port mirroring\n\nAfter you configured port mirroring from the domain controllers to the ATA Gateway, follow the instructions below to configure Windows Event forwarding using Source Initiated configuration. This is one way to configure Windows Event forwarding. \n\n**Step 1: Add the network service account to the domain Event Log Readers Group.** \n\nIn this scenario we are assuming that the ATA Gateway is a member of the domain.\n\n1.  Open Active Directory Users and Computers, navigate to the **BuiltIn** folder and double click **Event Log Readers**. \n2.  Select **Members**.\n4.  If **Network Service** is not listed, click **Add**, type **Network Service** in the **Enter the object names to select** field. Then click **Check Names** and click **OK** twice. \n\n**Step 2: Create a policy on the domain controllers to set the Configure target Subscription Manager setting.** \n> [!Note] \n> You can create a group policy for these settings and apply the group policy to each domain controller monitored by the ATA Gateway. The steps below modify the local policy of the domain controller.     \n\n1.  Run the following command on each domain controller: *winrm quickconfig*\n2.  From a command prompt type *gpedit.msc*.\n3.  Expand **Computer Configuration > Administrative Templates > Windows Components > Event Forwarding**\n\n ![Local policy group editor image](media/wef 1 local group policy editor.png)\n\n4.  Double click **Configure target Subscription Manager**.\n   \n    1.  Select **Enabled**.\n    2.  Under **Options** click **Show**.\n    3.  Under **SubscriptionManagers** enter the following value and click **OK**:  *Server=http://<fqdnATAGateway>:5985/wsman/SubscriptionManager/WEC,Refresh=10* (For example: Server=http://atagateway9.contoso.com:5985/wsman/SubscriptionManager/WEC,Refresh=10)\n \n   ![Configure target subscription image](media/wef 2 config target sub manager.png)\n   \n    5.  Click **OK**.\n    6.  From an elevated command prompt type *gpupdate /force*. \n\n**Step 3: Perform the following steps on the ATA Gateway** \n\n1.  Open an elevated command prompt and type *wecutil qc*\n2.  Open **Event Viewer**. \n3.  Right click **Subscriptions** and select **Create Subscription**. \n\n   1.   Enter a name and description for the subscription. \n   2.   For **Destination Log** confirm that **Forwarded Events** is selected. For ATA to read the events, the destination log must be **Forwarded Events**. \n   3.   Select **Source computer initiated** and click **Select Computers Groups**.\n        1.  Click **Add Domain Computer**.\n        2.  Enter the name of the domain controller in the **Enter the object name to select** field. Then click **Check Names** and click **OK**. \n       \n        ![Event Viewer image](media/wef3 event viewer.png)\n   \n        \n        3.  Click **OK**.\n   4.   Click **Select Events**.\n\n        1. Click **By log** and select **Security**.\n        2. In the **Includes/Excludes Event ID** field type **4776** and click **OK**. \n\n ![Query filter image](media/wef 4 query filter.png)\n\n   5.   Right click the created subscription and select **Runtime Status** to see if there are any issues with the status. \n   6.   After a few minutes, check to see that event 4776 is showing up in the Forwarded Events on the ATA Gateway.\n\n\n### WEF configuration for the ATA Lightweight Gateway\nWhen you install the ATA Lightweight Gateway on your domain controllers, you can set up your domain controllers to forward the events to itself. \nPerform the following steps to configure the Window Event Forwarding when using the ATA Lightweight Gateway. This is one way to configure Windows Event forwarding.  \n\n**Step 1: Add the network service account to the domain Event Log Readers Group** \n\n1.  Open Active Directory Users and Computer, navigate to the **BuiltIn** folder and double click **Event Log Readers**. \n2.  Select **Members**.\n3.  If **Network Service** is not listed, click **Add** and type **Network Service** in the **Enter the object names to select** field. Then click **Check Names** and click **OK** twice. \n\n**Step 2: Perform the following steps on the domain controller after the ATA Lightweight Gateway is installed** \n\n1.  Open an elevated command prompt and type *winrm quickconfig* and *wecutil qc* \n2.  Open **Event Viewer**. \n3.  Right click **Subscriptions** and select **Create Subscription**. \n\n   1.   Enter a name and description for the subscription. \n   2.   For **Destination Log** confirm that **Forwarded Events** is selected. For ATA to read the events the destination log must be Forwarded Events.\n\n        1.  Select **Collector initiated** and click **Select Computers**. Then click **Add Domain Computer**.\n        2.  Enter the name of the domain controller in the **Enter the object name to select**. Then click **Check Names** and click **OK**.\n\n            ![Subscription properties image](media/wef 5 sub properties computers.png)\n\n        3.  Click **OK**.\n   3.   Click **Select Events**.\n\n        1.  Click **By log** and select **Security**.\n        2.  In the **Includes/Excludes Event ID** type *4776* and click **OK**. \n\n![Query filter image](media/wef 4 query filter.png)\n\n\n  4.    Right click the created subscription and select **Runtime Status** to see if there are any issues with the status. \n\n> [!Note] \n> You may need to reboot the domain controller before the setting take effect. \n\nAfter a few minutes, check to see that event 4776 is showing up in the Forwarded Events on the ATA Gateway.\n\n\n\nFor more information see: [Configure the computers to forward and collect events](https://technet.microsoft.com/library/cc748890)\n\n## See Also\n- [Install ATA](install-ata.md)\n- [Check out the ATA forum!!](https://social.technet.microsoft.com/Forums/security/en-US/home?forum=mata)\n"}