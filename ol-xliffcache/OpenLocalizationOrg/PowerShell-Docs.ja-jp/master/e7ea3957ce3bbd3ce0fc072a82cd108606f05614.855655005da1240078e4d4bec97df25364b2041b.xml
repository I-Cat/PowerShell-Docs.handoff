{"nodes":[{"pos":[105,126],"content":"powershell,cmdlet,jea","needQuote":true,"nodes":[{"content":"powershell,cmdlet,jea","pos":[0,21]}]},{"pos":[156,185],"content":"end to end   active directory","needQuote":true,"nodes":[{"content":"end to end   active directory","pos":[0,29]}]},{"content":"End to End - Active Directory","pos":[220,249]},{"content":"Imagine the scope of your program has increased.","pos":[250,298]},{"content":"You are now responsible for adding JEA to Domain Controllers to perform Active Directory actions.","pos":[299,396],"source":"\nYou are now responsible for adding JEA to Domain Controllers to perform Active Directory actions."},{"content":"The help desk people are going to use JEA to unlock accounts, reset passwords, and do other similar actions.","pos":[397,505],"source":"\nThe help desk people are going to use JEA to unlock accounts, reset passwords, and do other similar actions."},{"content":"You need to expose a completely new set of commands to a different group of people.","pos":[507,590]},{"content":"On top of that, you have a bunch of existing Active Directory scripts you need to expose.","pos":[591,680],"source":"\nOn top of that, you have a bunch of existing Active Directory scripts you need to expose."},{"content":"This section will walk through authoring a Session Configuration and Role Capability for this task.","pos":[681,780],"source":"\nThis section will walk through authoring a Session Configuration and Role Capability for this task."},{"content":"Prerequisites","pos":[785,798]},{"content":"To follow this section step-by-step, you'll need to be operating on a domain controller.","pos":[799,887]},{"content":"If you don't have access to your domain controller, don't worry.","pos":[888,952],"source":"\nIf you don't have access to your domain controller, don't worry."},{"content":"Try to follow along with by working against some other scenario or role with which you are familiar.","pos":[953,1053],"source":"\nTry to follow along with by working against some other scenario or role with which you are familiar."},{"content":"If you want to quickly set up a new domain controller, check out the <bpt id=\"p1\">[</bpt>Creating a Domain Controller appendix<ept id=\"p1\">](.\\creating-a-domain-controller.md)</ept>.","pos":[1054,1198],"source":"\nIf you want to quickly set up a new domain controller, check out the [Creating a Domain Controller appendix](.\\creating-a-domain-controller.md)."},{"content":"Steps to Make a new Role Capability and Session Configuration","pos":[1203,1264]},{"content":"Making a new role capability can seem daunting at first, but it can be broken into fairly simple steps:","pos":[1266,1369]},{"content":"Identify the tasks you need to enable","pos":[1375,1412]},{"content":"Restrict those tasks as necessary","pos":[1417,1450]},{"content":"Confirm they work with JEA","pos":[1455,1481]},{"content":"Put them in a Role Capability file","pos":[1486,1520]},{"content":"Register a Session Configuration that exposes that Role Capability","pos":[1525,1591]},{"content":"Step 1: Identify What Needs to Be Exposed","pos":[1596,1637]},{"content":"Before you make a new Role Capability or Session Configuration, you need to identify all of the things users will need to do through the JEA endpoint, as well as how to do them through PowerShell.","pos":[1638,1834]},{"content":"This will involve a fair amount of requirement gathering and research.","pos":[1835,1905],"source":"\nThis will involve a fair amount of requirement gathering and research."},{"content":"How you go about this process will depend on your organization and goals.","pos":[1906,1979],"source":"\nHow you go about this process will depend on your organization and goals."},{"content":"It is important to call out requirement gathering and research as a critical part of the real world process.","pos":[1980,2088],"source":"\nIt is important to call out requirement gathering and research as a critical part of the real world process."},{"content":"This may be the most difficult step in the process of adopting JEA.","pos":[2089,2156],"source":"\nThis may be the most difficult step in the process of adopting JEA."},{"content":"Find Resources","pos":[2162,2176]},{"content":"Here is a set of online resources that might have come up in your research on creating an Active Directory management endpoint:","pos":[2177,2304]},{"pos":[2309,2446],"content":"<bpt id=\"p1\">[</bpt>Active Directory PowerShell Overview<ept id=\"p1\">](http://blogs.msdn.com/b/adpowershell/archive/2009/03/05/active-directory-powershell-overview.aspx)</ept>","source":"[Active Directory PowerShell Overview](http://blogs.msdn.com/b/adpowershell/archive/2009/03/05/active-directory-powershell-overview.aspx)"},{"pos":[2451,2608],"content":"<bpt id=\"p1\">[</bpt>CMD to PowerShell Guide for Active Directory<ept id=\"p1\">](http://blogs.technet.com/b/ashleymcglone/archive/2013/01/02/free-download-cmd-to-powershell-guide-for-ad.aspx)</ept>","source":"[CMD to PowerShell Guide for Active Directory](http://blogs.technet.com/b/ashleymcglone/archive/2013/01/02/free-download-cmd-to-powershell-guide-for-ad.aspx)"},{"content":"Make a List","pos":[2614,2625]},{"content":"Here is a set of ten actions that you will be working from in the remainder of this section.","pos":[2626,2718]},{"content":"Keep in mind this is simply an example, your organizations requirements may be different:","pos":[2719,2808],"source":"\nKeep in mind this is simply an example, your organizations requirements may be different:"},{"content":"Action","pos":[2811,2817]},{"content":"PowerShell Command","pos":[2875,2893]},{"content":"Account Unlock","pos":[3071,3085]},{"content":"Password Reset","pos":[3201,3215]},{"pos":[3265,3328],"content":"<ph id=\"ph1\">`Set-ADAccountPassword`</ph> and <ph id=\"ph2\">`Set-ADUser -ChangePasswordAtLogon`</ph>","source":"`Set-ADAccountPassword` and `Set-ADUser -ChangePasswordAtLogon`"},{"content":"Change a User's Title","pos":[3331,3352]},{"content":"Find AD Accounts that are locked out, disabled, inactive, etc.","pos":[3463,3525]},{"content":"Add User to Group","pos":[3593,3610]},{"content":"Remove User from Group","pos":[3723,3745]},{"content":"Enable a user account","pos":[3853,3874]},{"content":"Disable a user account","pos":[3983,4005]},{"content":"Step 2: Restrict Tasks as Necessary","pos":[4116,4151]},{"content":"Now that you have your list of actions, you need to think through the capabilities of each command.","pos":[4153,4252]},{"content":"There are two important reasons to do this:","pos":[4253,4296],"source":"\nThere are two important reasons to do this:"},{"content":"It is easy to give users more capabilities than you intend.","pos":[4302,4361]},{"content":"For example, <ph id=\"ph1\">`Set-ADUser`</ph> is an incredibly powerful and flexible command.","pos":[4362,4435],"source":"\nFor example, `Set-ADUser` is an incredibly powerful and flexible command."},{"content":"You may not want to expose everything it can do to help desk users.","pos":[4436,4503],"source":"\nYou may not want to expose everything it can do to help desk users."},{"content":"Even worse, it's possible to expose commands that allow users to escape JEA's restrictions.","pos":[4511,4602]},{"content":"If this happens, JEA ceases to function as a security boundary.","pos":[4603,4666],"source":"\nIf this happens, JEA ceases to function as a security boundary."},{"content":"Please be careful when selecting commands.","pos":[4667,4709],"source":"\nPlease be careful when selecting commands."},{"content":"For example, Invoke-Expression will allow users to run unrestricted code.","pos":[4710,4783],"source":"\nFor example, Invoke-Expression will allow users to run unrestricted code."},{"content":"For more discussion on this topic, check out the Considerations When Restricting Commands section.","pos":[4784,4882],"source":"\nFor more discussion on this topic, check out the Considerations When Restricting Commands section."},{"content":"After reviewing each command, you decide to restrict the following:","pos":[4884,4951]},{"pos":[4957,5025],"content":"<ph id=\"ph1\">`Set-ADUser`</ph> should only be allowed to run with the -Title parameter","source":"`Set-ADUser` should only be allowed to run with the -Title parameter"},{"pos":[5031,5114],"content":"<ph id=\"ph1\">`Add-ADGroupMember`</ph> and <ph id=\"ph2\">`Remove-ADGroupMember`</ph> should only work with certain groups","source":"`Add-ADGroupMember` and `Remove-ADGroupMember` should only work with certain groups"},{"content":"Step 3: Confirm the Tasks Work with JEA","pos":[5120,5159]},{"content":"Actually using those cmdlets may not be straightforward in the restricted JEA environment.","pos":[5160,5250]},{"content":"JEA runs in <bpt id=\"p1\">*</bpt>NoLanguage<ept id=\"p1\">*</ept> mode which, among other things, prevents users from using variables.","pos":[5251,5344],"source":"\nJEA runs in *NoLanguage* mode which, among other things, prevents users from using variables."},{"content":"In order to ensure that end users have a smooth experience, it's important to check for a few things.","pos":[5345,5446],"source":"\nIn order to ensure that end users have a smooth experience, it's important to check for a few things."},{"content":"As an example, consider <ph id=\"ph1\">`Set-ADAccountPassword`</ph>.","pos":[5448,5496],"source":"As an example, consider `Set-ADAccountPassword`."},{"content":"The -NewPassword parameter requires a secure string.","pos":[5497,5549],"source":"\nThe -NewPassword parameter requires a secure string."},{"content":"Often, users create a secure string and pass it in as a variable (as below):","pos":[5550,5626],"source":"\nOften, users create a secure string and pass it in as a variable (as below):"},{"content":"However, <bpt id=\"p1\">*</bpt>NoLanguage<ept id=\"p1\">*</ept> mode prevents the usage of variables.","pos":[5793,5852],"source":"However, *NoLanguage* mode prevents the usage of variables."},{"content":"You can get around this restriction in two ways:","pos":[5853,5901],"source":"\nYou can get around this restriction in two ways:"},{"content":"You can require users run the command without assigning variables.","pos":[5907,5973]},{"content":"This is easy to configure, but can be painful for the operators using the endpoint.","pos":[5974,6057],"source":"\nThis is easy to configure, but can be painful for the operators using the endpoint."},{"content":"Who wants to type this out every time you reset a password?","pos":[6058,6117],"source":"\nWho wants to type this out every time you reset a password?"},{"content":"You can wrap the complexity in a script or a function that you expose to end users.","pos":[6261,6344]},{"content":"Scripts and functions that you expose run in an unrestricted context; you can write functions that use variables and call other commands without any issue.","pos":[6345,6500],"source":"\nScripts and functions that you expose run in an unrestricted context; you can write functions that use variables and call other commands without any issue."},{"content":"This approach simplifies the end user experience, prevents errors, reduces required PowerShell knowledge, and reduces unintentionally exposing excess functionality.","pos":[6501,6665],"source":"\nThis approach simplifies the end user experience, prevents errors, reduces required PowerShell knowledge, and reduces unintentionally exposing excess functionality."},{"content":"The only downside is the cost of authoring and maintaining the function.","pos":[6666,6738],"source":"\nThe only downside is the cost of authoring and maintaining the function."},{"content":"Aside: Adding a Function to your Module","pos":[6744,6783]},{"content":"Taking approach #2, you are going to write a PowerShell function called <ph id=\"ph1\">`Reset-ContosoUserPassword`</ph>.","pos":[6784,6884],"source":"Taking approach #2, you are going to write a PowerShell function called `Reset-ContosoUserPassword`."},{"content":"This function is going to do everything that needs to happen when you reset a user's password.","pos":[6885,6979],"source":"\nThis function is going to do everything that needs to happen when you reset a user's password."},{"content":"In your organization, this may involve doing fancy and complicated things.","pos":[6980,7054],"source":"\nIn your organization, this may involve doing fancy and complicated things."},{"content":"Because this is just an example, your command will just reset the password and require the user change the password at logon.","pos":[7055,7180],"source":"\nBecause this is just an example, your command will just reset the password and require the user change the password at logon."},{"content":"We will put it in the Contoso_AD_Module module you made in the last section.","pos":[7181,7257],"source":"\nWe will put it in the Contoso_AD_Module module you made in the last section."},{"content":"In PowerShell ISE, open \"Contoso_AD_Module.psm1\"","pos":[7262,7310]},{"content":"Press Crtl+J to open the snippets menu.","pos":[7423,7462]},{"content":"Key down until you find \"function\" and press enter.","pos":[7467,7518]},{"content":"This puts up a super basic skeleton of a function.","pos":[7519,7569],"source":"\nThis puts up a super basic skeleton of a function."},{"content":"Rename the function \"Reset-ContosoUserPassword\".","pos":[7574,7622]},{"content":"Rename one of the parameters \"Identity\" and delete the second.","pos":[7629,7691]},{"content":"Copy the following into the body of the function.","pos":[7696,7745]},{"content":"Save the file.","pos":[8055,8069]},{"content":"You should end up with something that looks like this:","pos":[8070,8124],"source":"\nYou should end up with something that looks like this:"},{"pos":[8481,8610],"content":"Now, your users can simply call <ph id=\"ph1\">`Reset-ContosoUserPassword`</ph> and not have to remember the syntax to create a secure string inline.","source":"Now, your users can simply call `Reset-ContosoUserPassword` and not have to remember the syntax to create a secure string inline."},{"content":"Step 4: Edit the Role Capability File","pos":[8615,8652]},{"content":"In the <bpt id=\"p1\">[</bpt>Role Capability Creation<ept id=\"p1\">](./role-capabilities.md#role-capability-creation)</ept> section, you created a blank Role Capability file.","pos":[8653,8786],"source":"In the [Role Capability Creation](./role-capabilities.md#role-capability-creation) section, you created a blank Role Capability file."},{"content":"In this section, you will fill in the values in that file.","pos":[8787,8845],"source":"\nIn this section, you will fill in the values in that file."},{"content":"Start by opening the role capability file in PowerShell ISE.","pos":[8847,8907]},{"content":"Update the file with the following changes:","pos":[9026,9069]},{"content":"There are a few things to note about the above:","pos":[10013,10060]},{"content":"PowerShell will attempt to auto-load the modules needed for your Role Capability.","pos":[10065,10146]},{"content":"You may need to explicitly list module names in the \"ModulesToImport\" field if you notice problems with a module not being autoloaded.","pos":[10147,10281],"source":"\nYou may need to explicitly list module names in the \"ModulesToImport\" field if you notice problems with a module not being autoloaded."},{"pos":[10287,10402],"content":"If you aren't sure if a command is a cmdlet or a function, run <ph id=\"ph1\">`Get-Command`</ph> and look at the \"CommandType\" property","source":"If you aren't sure if a command is a cmdlet or a function, run `Get-Command` and look at the \"CommandType\" property"},{"content":"The ValidatePattern allows you to use a regular expression to restrict parameter arguments if it is not easy to define a set of allowable values.","pos":[10408,10553]},{"content":"You cannot define both a ValidatePattern and ValidateSet for a single parameter.","pos":[10554,10634],"source":"\nYou cannot define both a ValidatePattern and ValidateSet for a single parameter."},{"content":"Step 5: Register a new Session Configuration","pos":[10639,10683]},{"content":"Next, you will create a new session configuration file that will expose your Role Capability to members of the \"JEA_NonAdmin_HelpDesk\" AD group.","pos":[10684,10828]},{"content":"Start by creating and opening a new blank Session Configuration file in PowerShell ISE.","pos":[10830,10917]},{"content":"Modify the following fields in the PSSC file.","pos":[11085,11130]},{"content":"If you are working in your own environment, you should replace \"CONTOSO\\JEA_NonAdmins_Helpdesk\" with your own non-administrator user or group.","pos":[11131,11273],"source":"\nIf you are working in your own environment, you should replace \"CONTOSO\\JEA_NonAdmins_Helpdesk\" with your own non-administrator user or group."},{"content":"Save and register the Session Configuration","pos":[11878,11921]},{"content":"Test It Out!","pos":[12052,12064]},{"content":"Get your non-administrator user credentials:","pos":[12065,12109]},{"pos":[12159,12295],"content":"If you followed the <bpt id=\"p1\">[</bpt>Set Up Users and Groups<ept id=\"p1\">](creating-a-domain-controller.md#set-up-users-and-groups)</ept> section, the credentials will be:","source":"If you followed the [Set Up Users and Groups](creating-a-domain-controller.md#set-up-users-and-groups) section, the credentials will be:"},{"content":"Username = \"HelpDeskUser\"","pos":[12300,12325]},{"content":"Password = \"pa$$w0rd\"","pos":[12330,12351]},{"content":"Remote into the ADHelpdesk endpoint using the non-admin credential:","pos":[12353,12420]},{"content":"Use Set-ADUser to reset a user's title.","pos":[12527,12566]},{"content":"Verify that the title has changed.","pos":[12635,12669]},{"content":"Now, use Add-ADGroupMember to add a user to the TestGroup.","pos":[12738,12796]},{"content":"Note: make sure you've created the TestGroup beforehand.","pos":[12797,12853],"source":"\nNote: make sure you've created the TestGroup beforehand."},{"content":"Exit the session:","pos":[12930,12947]},{"content":"Key Concepts","pos":[12984,12996]},{"content":"<bpt id=\"p1\">**</bpt>NoLanguage Mode<ept id=\"p1\">**</ept>: When PowerShell is in \"NoLanguage\" mode, users may only run commands; they cannot use any language elements.","pos":[12997,13126],"source":"**NoLanguage Mode**:\nWhen PowerShell is in \"NoLanguage\" mode, users may only run commands; they cannot use any language elements."},{"content":"For more information, run <ph id=\"ph1\">`Get-Help about_Language_Modes`</ph>.","pos":[13127,13185],"source":"\nFor more information, run `Get-Help about_Language_Modes`."},{"content":"<bpt id=\"p1\">**</bpt>PowerShell Functions<ept id=\"p1\">**</ept>: PowerShell functions are bits of PowerShell code that you can call by name.","pos":[13187,13288],"source":"**PowerShell Functions**:\nPowerShell functions are bits of PowerShell code that you can call by name."},{"content":"For more information, run <ph id=\"ph1\">`Get-Help about_Functions`</ph>.","pos":[13289,13342],"source":"\nFor more information, run `Get-Help about_Functions`."},{"content":"<bpt id=\"p1\">**</bpt>ValidateSet/ValidatePattern<ept id=\"p1\">**</ept>: When exposing a command, you can restrict valid arguments for specific parameters.","pos":[13344,13459],"source":"**ValidateSet/ValidatePattern**:\nWhen exposing a command, you can restrict valid arguments for specific parameters."},{"content":"A ValidateSet is a specific list of valid arguments.","pos":[13460,13512],"source":"\nA ValidateSet is a specific list of valid arguments."},{"content":"A ValidatePattern is a regular expression that the arguments for that parameter must match.","pos":[13513,13604],"source":"\nA ValidatePattern is a regular expression that the arguments for that parameter must match."}],"content":"---\ndescription:  \nmanager:  dongill\nms.topic:  article\nauthor:  jpjofre\nms.prod:  powershell\nkeywords:  powershell,cmdlet,jea\nms.date:  2016-06-22\ntitle:  end to end   active directory\nms.technology:  powershell\n---\n\n# End to End - Active Directory\nImagine the scope of your program has increased.\nYou are now responsible for adding JEA to Domain Controllers to perform Active Directory actions.\nThe help desk people are going to use JEA to unlock accounts, reset passwords, and do other similar actions.\n\nYou need to expose a completely new set of commands to a different group of people.\nOn top of that, you have a bunch of existing Active Directory scripts you need to expose.\nThis section will walk through authoring a Session Configuration and Role Capability for this task.\n\n## Prerequisites\nTo follow this section step-by-step, you'll need to be operating on a domain controller.\nIf you don't have access to your domain controller, don't worry.\nTry to follow along with by working against some other scenario or role with which you are familiar.\nIf you want to quickly set up a new domain controller, check out the [Creating a Domain Controller appendix](.\\creating-a-domain-controller.md).\n\n## Steps to Make a new Role Capability and Session Configuration\n\nMaking a new role capability can seem daunting at first, but it can be broken into fairly simple steps:\n\n1.  Identify the tasks you need to enable\n2.  Restrict those tasks as necessary\n3.  Confirm they work with JEA\n4.  Put them in a Role Capability file\n5.  Register a Session Configuration that exposes that Role Capability\n\n## Step 1: Identify What Needs to Be Exposed\nBefore you make a new Role Capability or Session Configuration, you need to identify all of the things users will need to do through the JEA endpoint, as well as how to do them through PowerShell.\nThis will involve a fair amount of requirement gathering and research.\nHow you go about this process will depend on your organization and goals.\nIt is important to call out requirement gathering and research as a critical part of the real world process.\nThis may be the most difficult step in the process of adopting JEA.\n\n### Find Resources\nHere is a set of online resources that might have come up in your research on creating an Active Directory management endpoint:\n-   [Active Directory PowerShell Overview](http://blogs.msdn.com/b/adpowershell/archive/2009/03/05/active-directory-powershell-overview.aspx)\n-   [CMD to PowerShell Guide for Active Directory](http://blogs.technet.com/b/ashleymcglone/archive/2013/01/02/free-download-cmd-to-powershell-guide-for-ad.aspx)\n\n### Make a List\nHere is a set of ten actions that you will be working from in the remainder of this section.\nKeep in mind this is simply an example, your organizations requirements may be different:\n\n|Action                                                         |PowerShell Command                                             |\n|---------------------------------------------------------------|---------------------------------------------------------------|\n|Account Unlock                                                 |`Unlock-ADAccount`                                             |\n|Password Reset                                                 |`Set-ADAccountPassword` and `Set-ADUser -ChangePasswordAtLogon`|\n|Change a User's Title                                          |`Set-ADUser -Title`                                            |  \n|Find AD Accounts that are locked out, disabled, inactive, etc. |`Search-ADAccount`                                             |\n|Add User to Group                                              |`Add-ADGroupMember -Identity (with whitelist) -Members`        |\n|Remove User from Group                                         |`Remove-ADGroupMember -Identity (with whitelist) -Members`     |\n|Enable a user account                                          |`Enable-ADAccount`                                             |\n|Disable a user account                                         |`Disable-ADAccount`                                            |\n\n## Step 2: Restrict Tasks as Necessary\n\nNow that you have your list of actions, you need to think through the capabilities of each command.\nThere are two important reasons to do this:\n\n1.  It is easy to give users more capabilities than you intend.\nFor example, `Set-ADUser` is an incredibly powerful and flexible command.\nYou may not want to expose everything it can do to help desk users.  \n\n2.  Even worse, it's possible to expose commands that allow users to escape JEA's restrictions.\nIf this happens, JEA ceases to function as a security boundary.\nPlease be careful when selecting commands.\nFor example, Invoke-Expression will allow users to run unrestricted code.\nFor more discussion on this topic, check out the Considerations When Restricting Commands section.\n\nAfter reviewing each command, you decide to restrict the following:\n\n1.  `Set-ADUser` should only be allowed to run with the -Title parameter\n\n2.  `Add-ADGroupMember` and `Remove-ADGroupMember` should only work with certain groups\n\n### Step 3: Confirm the Tasks Work with JEA\nActually using those cmdlets may not be straightforward in the restricted JEA environment.\nJEA runs in *NoLanguage* mode which, among other things, prevents users from using variables.\nIn order to ensure that end users have a smooth experience, it's important to check for a few things.\n\nAs an example, consider `Set-ADAccountPassword`.\nThe -NewPassword parameter requires a secure string.\nOften, users create a secure string and pass it in as a variable (as below):\n\n```PowerShell\n$newPassword = Read-Host -Prompt \"Specify a new password\" -AsSecureString\nSet-ADAccountPassword -Identity mollyd -NewPassword $newPassword -Reset\n```\n\nHowever, *NoLanguage* mode prevents the usage of variables.\nYou can get around this restriction in two ways:\n\n1.  You can require users run the command without assigning variables.\nThis is easy to configure, but can be painful for the operators using the endpoint.\nWho wants to type this out every time you reset a password?\n```PowerShell\nSet-ADAccountPassword -Identity mollyd -NewPassword (Read-Host -Prompt \"Specify a new password\" -AsSecureString) -Reset\n```\n\n2.  You can wrap the complexity in a script or a function that you expose to end users.\nScripts and functions that you expose run in an unrestricted context; you can write functions that use variables and call other commands without any issue.\nThis approach simplifies the end user experience, prevents errors, reduces required PowerShell knowledge, and reduces unintentionally exposing excess functionality.\nThe only downside is the cost of authoring and maintaining the function.\n\n### Aside: Adding a Function to your Module\nTaking approach #2, you are going to write a PowerShell function called `Reset-ContosoUserPassword`.\nThis function is going to do everything that needs to happen when you reset a user's password.\nIn your organization, this may involve doing fancy and complicated things.\nBecause this is just an example, your command will just reset the password and require the user change the password at logon.\nWe will put it in the Contoso_AD_Module module you made in the last section.\n\n1. In PowerShell ISE, open \"Contoso_AD_Module.psm1\"\n```PowerShell\nise 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module\\Contoso_AD_Module.psm1'\n```\n\n2. Press Crtl+J to open the snippets menu.\n\n3. Key down until you find \"function\" and press enter.\nThis puts up a super basic skeleton of a function.\n\n4. Rename the function \"Reset-ContosoUserPassword\".  \n\n5. Rename one of the parameters \"Identity\" and delete the second.\n\n6. Copy the following into the body of the function.\n```PowerShell\n# Get the new password\n$NewPassword = Read-Host -Prompt \"Enter a new password\" -AsSecureString\n# Reset the password\nSet-ADAccountPassword -Identity $Identity -NewPassword $NewPassword -Reset\n# Require the user to reset at next logon\nSet-ADUser -Identity $Identity -ChangePasswordAtLogon\n```\n\n7. Save the file.\nYou should end up with something that looks like this:\n```PowerShell\nfunction Reset-ContosoUserPassword ($Identity)\n{\n# Get the new password\n$NewPassword = Read-Host -Prompt \"Enter a new password\" -AsSecureString\n# Reset the password\nSet-ADAccountPassword -Identity $Identity -NewPassword $NewPassword -Reset\n# Require the user to reset at next logon\nSet-ADUser -Identity $Identity -ChangePasswordAtLogon\n}\n```\nNow, your users can simply call `Reset-ContosoUserPassword` and not have to remember the syntax to create a secure string inline.\n\n## Step 4: Edit the Role Capability File\nIn the [Role Capability Creation](./role-capabilities.md#role-capability-creation) section, you created a blank Role Capability file.\nIn this section, you will fill in the values in that file.\n\nStart by opening the role capability file in PowerShell ISE.\n```PowerShell\nise 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module\\RoleCapabilities\\ADHelpDesk.psrc'\n```\nUpdate the file with the following changes:\n```PowerShell\n# OLD: VisibleCmdlets = 'Invoke-Cmdlet1', @{ Name = 'Invoke-Cmdlet2'; Parameters = @{ Name = 'Parameter1'; ValidateSet = 'Item1', 'Item2' }, @{ Name = 'Parameter2'; ValidatePattern = 'L*' } }\nVisibleCmdlets =\n    'Unlock-ADAccount',\n    'Search-ADAccount',\n    'Enable-ADAccount',\n    'Disable-ADAccount',\n    @{ Name = 'Set-ADUser'; Parameters = @{ Name = 'Title'; ValidateSet = 'Manager', 'Engineer' }},\n    @{ Name = 'Add-ADGroupMember'; Parameters =\n        @{Name = 'Identity'; ValidateSet = 'TestGroup'},\n        @{Name = 'Members'}},\n    @{ Name = 'Remove-ADGroupMember'; Parameters =\n        @{Name = 'Identity'; ValidateSet = 'TestGroup'},\n        @{Name = 'Members'}}\n\n# OLD: VisibleFunctions = 'Invoke-Function1', @{ Name = 'Invoke-Function2'; Parameters = @{ Name = 'Parameter1'; ValidateSet = 'Item1', 'Item2' }, @{ Name = 'Parameter2'; ValidatePattern = 'L*' } }\nVisibleFunctions = 'Reset-ContosoUserPassword'\n```\n\nThere are a few things to note about the above:\n1.  PowerShell will attempt to auto-load the modules needed for your Role Capability.\nYou may need to explicitly list module names in the \"ModulesToImport\" field if you notice problems with a module not being autoloaded.\n\n2.  If you aren't sure if a command is a cmdlet or a function, run `Get-Command` and look at the \"CommandType\" property\n\n3.  The ValidatePattern allows you to use a regular expression to restrict parameter arguments if it is not easy to define a set of allowable values.\nYou cannot define both a ValidatePattern and ValidateSet for a single parameter.\n\n## Step 5: Register a new Session Configuration\nNext, you will create a new session configuration file that will expose your Role Capability to members of the \"JEA_NonAdmin_HelpDesk\" AD group.\n\nStart by creating and opening a new blank Session Configuration file in PowerShell ISE.\n```PowerShell\nNew-PSSessionConfigurationFile -Path \"$env:ProgramData\\JEAConfiguration\\HelpDeskDemo.pssc\"\nise \"$env:ProgramData\\JEAConfiguration\\HelpDeskDemo.pssc\"\n```\nModify the following fields in the PSSC file.\nIf you are working in your own environment, you should replace \"CONTOSO\\JEA_NonAdmins_Helpdesk\" with your own non-administrator user or group.\n```PowerShell\n# OLD: Description = ''\nDescription = 'An endpoint for Active Directory tasks.'\n\n# OLD: SessionType = 'Default'\nSessionType = 'RestrictedRemoteServer'\n\n# OLD: TranscriptDirectory = 'C:\\Transcripts\\'\nTranscriptDirectory = \"C:\\ProgramData\\JEAConfiguration\\Transcripts\"\n\n# OLD: RunAsVirtualAccount = $true\nRunAsVirtualAccount = $true\n\n# OLD: RoleDefinitions = @{ 'CONTOSO\\SqlAdmins' = @{ RoleCapabilities = 'SqlAdministration' }; 'CONTOSO\\ServerMonitors' = @{ VisibleCmdlets = 'Get-Process' } }\nRoleDefinitions = @{ 'CONTOSO\\JEA_NonAdmin_HelpDesk' = @{ RoleCapabilities =  'ADHelpDesk' }}\n```\nSave and register the Session Configuration\n```PowerShell\nRegister-PSSessionConfiguration -Name ADHelpDesk -Path \"$env:ProgramData\\JEAConfiguration\\HelpDeskDemo.pssc\"\n```\n## Test It Out!\nGet your non-administrator user credentials:\n```PowerShell\n$HelpDeskCred = Get-Credential\n```\nIf you followed the [Set Up Users and Groups](creating-a-domain-controller.md#set-up-users-and-groups) section, the credentials will be:\n-   Username = \"HelpDeskUser\"\n-   Password = \"pa$$w0rd\"\n\nRemote into the ADHelpdesk endpoint using the non-admin credential:\n```PowerShell\nEnter-PSSession -ComputerName . -ConfigurationName ADHelpDesk -Credential $HelpDeskCred\n```\nUse Set-ADUser to reset a user's title.\n```PowerShell\nSet-ADUser -Identity OperatorUser -Title Engineer\n```\nVerify that the title has changed.\n```PowerShell\nGet-ADUser -Identity OperatorUser -Property Title\n```\nNow, use Add-ADGroupMember to add a user to the TestGroup.\nNote: make sure you've created the TestGroup beforehand.\n```PowerShell\nAdd-ADGroupMember TestGroup -Member OperatorUser -Verbose\n```\nExit the session:\n```PowerShell\nExit-PSSession\n```\n## Key Concepts\n**NoLanguage Mode**:\nWhen PowerShell is in \"NoLanguage\" mode, users may only run commands; they cannot use any language elements.\nFor more information, run `Get-Help about_Language_Modes`.\n\n**PowerShell Functions**:\nPowerShell functions are bits of PowerShell code that you can call by name.\nFor more information, run `Get-Help about_Functions`.\n\n**ValidateSet/ValidatePattern**:\nWhen exposing a command, you can restrict valid arguments for specific parameters.\nA ValidateSet is a specific list of valid arguments.\nA ValidatePattern is a regular expression that the arguments for that parameter must match.\n\n"}