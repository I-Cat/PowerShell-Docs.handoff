{"nodes":[{"pos":[11,59],"content":"DSC Module and Configuration Signing validations","needQuote":true,"nodes":[{"content":"DSC Module and Configuration Signing validations","pos":[0,48]}]},{"content":"DSC Module and Configuration Signing validations","pos":[106,154]},{"content":"In DSC, configuration documents and modules are distributed to managed machines from the pull server or pull server (in the case of Azure Automation pull service).","pos":[155,318]},{"content":"If the pull server/service is compromised, an attacker can potentially modify the configurations and modules on the pull server and have it distributed to all managed machines, thus compromising even more machines of the customer.","pos":[319,549]},{"content":"This threat is addressed in WMF 5.1.","pos":[553,589]},{"content":"DSC supports validating the digital signatures on modules and configuration (.MOF) files.","pos":[590,679]},{"content":"This feature will prevent nodes from executing a configuration or module files that are not signed by trusted signer or that have been tampered with after they have been signed by trusted signer.","pos":[680,875]},{"content":"How to sign configuration and module","pos":[883,919]},{"pos":[928,1115],"content":"Configuration Files (.MOFS):- The existing PowerShell cmdlet <bpt id=\"p1\">[</bpt>Set-AuthenticodeSignature<ept id=\"p1\">](https://technet.microsoft.com/library/hh849819.aspx)</ept> is extended to support signing of MOF files.","source":"Configuration Files (.MOFS):- \nThe existing PowerShell cmdlet [Set-AuthenticodeSignature](https://technet.microsoft.com/library/hh849819.aspx) is extended to support signing of MOF files."},{"pos":[1121,1229],"content":"Modules:- Signing of modules is done by signing the corresponding module catalog using the following steps:-","source":"Modules:-\nSigning of modules is done by signing the corresponding module catalog using the following steps:-"},{"content":"Create a catalog file: A catalog file contains a collection of cryptographic hashes, or thumbprints.","pos":[1237,1337]},{"content":"Each thumbprint corresponds to a file that is included in the module.","pos":[1338,1407]},{"content":"A new cmdlet <bpt id=\"p1\">[</bpt>New-FileCatalog<ept id=\"p1\">](https://technet.microsoft.com/library/cc732148.aspx)</ept>, has been added to enable users create a catalog file for their module.","pos":[1409,1564],"source":"  A new cmdlet [New-FileCatalog](https://technet.microsoft.com/library/cc732148.aspx),\nhas been added to enable users create a catalog file for their module."},{"content":"Please refer to the catalog cmdlets <bpt id=\"p1\">[</bpt>a relative link<ept id=\"p1\">](catalog-cmdlets.md)</ept> to create catalog files.","pos":[1565,1663],"source":" Please refer to the catalog cmdlets [a relative link](catalog-cmdlets.md) to create catalog files."},{"pos":[1671,1804],"content":"Sign the catalog file: using <bpt id=\"p1\">[</bpt>Set-AuthenticodeSignature<ept id=\"p1\">](https://technet.microsoft.com/library/hh849819.aspx)</ept> sign the catalog file.","source":"Sign the catalog file: \nusing [Set-AuthenticodeSignature](https://technet.microsoft.com/library/hh849819.aspx) sign the catalog file."},{"content":"Place the catalog file inside the module folder.","pos":[1811,1859]},{"content":"By convention, Module catalog file should be placed under the module folder with the same name as the module.","pos":[1860,1969],"source":"\nBy convention, Module catalog file should be placed under the module folder with the same name as the module."},{"content":"LocalConfigurationManager Settings to enable signing validations.","pos":[1974,2039]},{"content":"PULL","pos":[2045,2049]},{"content":"The LocalConfigurationManager of a node performs signing validation of modules and configurations based on its current settings.","pos":[2050,2178]},{"content":"By default, signature validation is disabled.","pos":[2179,2225],"source":" \nBy default, signature validation is disabled."},{"content":"Signature validation can enabled by adding ‘SignatureValidation’ block to the meta-configuration definition of the node as shown below:-","pos":[2226,2362]},{"content":"Setting the above metaconfiguration on a node enables signature validation on downloaded configurations and modules.","pos":[3488,3604]},{"content":"The localconfigurationmanager will perform the following steps to verify the digital signatures.","pos":[3605,3702],"source":" \nThe localconfigurationmanager will perform the following steps to verify the digital signatures."},{"content":"Verify the signature on a configuration file (.MOF) is valid.","pos":[3705,3766]},{"content":"It uses the powershell cmdlet <bpt id=\"p1\">[</bpt>Get-AuthenticodeSignature<ept id=\"p1\">](https://technet.microsoft.com/library/hh849805.aspx)</ept>, which is extended in 5.1 to support MOF sigature validation.","pos":[3767,3939],"source":" It uses the powershell cmdlet [Get-AuthenticodeSignature](https://technet.microsoft.com/library/hh849805.aspx), which is extended in 5.1 to support MOF sigature validation."},{"content":"Verify the certificate authority that authorized the signer is trusted.","pos":[3942,4013]},{"content":"Download module/resource dependencies of the configuration to a temp location.","pos":[4016,4094]},{"content":"Verify the signature of the catalog included inside the module.","pos":[4097,4160]},{"pos":[4167,4320],"content":"Find a <ph id=\"ph1\">&lt;moduleName&gt;</ph>.cat file and verify its signature using the cmdlet  <bpt id=\"p1\">[</bpt>Get-AuthenticodeSignature<ept id=\"p1\">](https://technet.microsoft.com/library/hh849805.aspx)</ept>.","source":"Find a <moduleName>.cat file and verify its signature using the cmdlet  [Get-AuthenticodeSignature](https://technet.microsoft.com/library/hh849805.aspx)."},{"content":"Verify the certification authority that authenticated the signer is trusted.","pos":[4327,4403]},{"pos":[4410,4559],"content":"Verify the content of the modules has not been tampered using the new cmdlet <bpt id=\"p1\">[</bpt>Test-FileCatalog<ept id=\"p1\">](https://technet.microsoft.com/library/cc732148.aspx)</ept>.","source":"Verify the content of the modules has not been tampered using the new cmdlet [Test-FileCatalog](https://technet.microsoft.com/library/cc732148.aspx)."},{"content":"Install-module to $env:ProgramFiles\\WindowsPowerShell\\Modules\\","pos":[4562,4624]},{"content":"Process configuration.","pos":[4627,4649]},{"content":"Note: - Signature validation on module-catalog and configuration is only performed when the configuration is applied to the system for the first time or when the module is downloaded and installed.","pos":[4651,4848]},{"content":"Consistency run does not validate signature of Current.mof or its module dependencies.","pos":[4849,4935]},{"content":"If verification has failed at any stage, for instance if the configuration pulled from the pullserver is unsigned, then processing of the configuration will be terminated with the error shown below and all temporary files will be deleted.","pos":[4936,5174],"source":"\nIf verification has failed at any stage, for instance if the configuration pulled from the pullserver is unsigned, then processing of the configuration will be terminated with the error shown below and all temporary files will be deleted."},{"content":"Sample Error Output Configuration","pos":[5178,5211]},{"content":"Similarily, Pulling a module whose catalog is not signed will result in the following error:-","pos":[5255,5348]},{"content":"Sample Error Output Module","pos":[5352,5378]},{"content":"PUSH","pos":[5423,5427]},{"content":"A configuration delivered via push might be tampered at its source before it is delivered to the node.","pos":[5428,5530]},{"content":"The Local configuration manager will perform similar signature validation steps for pushed or published configuration(s).","pos":[5531,5652]},{"content":"Below is a complete example of signature validation for push.","pos":[5653,5714],"source":"\nBelow is a complete example of signature validation for push."},{"content":"Enable signature validation on the node.","pos":[5718,5758]},{"content":"Create a sample configuration file.","pos":[6191,6226]},{"content":"Try pushing the unsigned configuration file in to the node.","pos":[6405,6464]},{"content":"ErrorUnsignedMofPushed","pos":[6546,6568]},{"content":"Sign the configurtion file using code-signing cert.","pos":[6607,6658]},{"content":"SignMofFile","pos":[6662,6673]},{"content":"Try pushing the signed mof file.","pos":[6708,6740]},{"content":"SignMofFile","pos":[6744,6755]}],"content":"---\ntitle: DSC Module and Configuration Signing validations\nauthor:  jaimeo\ncontributor: berheabra\n---\n\n##DSC Module and Configuration Signing validations\nIn DSC, configuration documents and modules are distributed to managed machines from the pull server or pull server (in the case of Azure Automation pull service). If the pull server/service is compromised, an attacker can potentially modify the configurations and modules on the pull server and have it distributed to all managed machines, thus compromising even more machines of the customer. \n\n This threat is addressed in WMF 5.1. DSC supports validating the digital signatures on modules and configuration (.MOF) files. This feature will prevent nodes from executing a configuration or module files that are not signed by trusted signer or that have been tampered with after they have been signed by trusted signer. \n\n\n\n###How to sign configuration and module \n***\n1. Configuration Files (.MOFS):- \nThe existing PowerShell cmdlet [Set-AuthenticodeSignature](https://technet.microsoft.com/library/hh849819.aspx) is extended to support signing of MOF files.  \n2. Modules:-\nSigning of modules is done by signing the corresponding module catalog using the following steps:- \n    * Create a catalog file: A catalog file contains a collection of cryptographic hashes, or thumbprints. Each thumbprint corresponds to a file that is included in the module.  A new cmdlet [New-FileCatalog](https://technet.microsoft.com/library/cc732148.aspx),\nhas been added to enable users create a catalog file for their module. Please refer to the catalog cmdlets [a relative link](catalog-cmdlets.md) to create catalog files. \n    * Sign the catalog file: \nusing [Set-AuthenticodeSignature](https://technet.microsoft.com/library/hh849819.aspx) sign the catalog file.\n    * Place the catalog file inside the module folder.\nBy convention, Module catalog file should be placed under the module folder with the same name as the module.\n\n###LocalConfigurationManager Settings to enable signing validations.\n\n####PULL\nThe LocalConfigurationManager of a node performs signing validation of modules and configurations based on its current settings. \nBy default, signature validation is disabled. Signature validation can enabled by adding ‘SignatureValidation’ block to the meta-configuration definition of the node as shown below:-\n\n```PowerShell\n[DSCLocalConfigurationManager()]\nConfiguration EnableSignatureValidation\n{\n    Settings\n    {\n        RefreshMode = 'PULL'        \n    } \n    \n    ConfigurationRepositoryWeb pullserver{\n      ConfigurationNames = 'sql'\n      ServerURL = 'http://localhost:8080/PSDSCPullServer/PSDSCPullServer.svc'\n      AllowUnsecureConnection = $true\n      RegistrationKey = 'd6750ff1-d8dd-49f7-8caf-7471ea9793fc' # Replace this with correct registration key.\n    }\n    SignatureValidation validations{\n        # By default,LCM will use default Windows trusted publisher store to validate the certificate chain. If TrustedStorePath property is specified, LCM will use this custom store for retrieving the trusted publishers to validate the content.\n        TrustedStorePath = 'Cert:\\LocalMachine\\DSCStore'            \n        SignedItemType =  'Configuration','Module'         # Those are list of DSC artifacts, for which LCM need to verify their digital signature before executing them on the node.       \n    }\n \n}\nEnableSignatureValidation\nSet-DscLocalConfigurationManager -Path .\\EnableSignatureValidation -Verbose \n ```\n\nSetting the above metaconfiguration on a node enables signature validation on downloaded configurations and modules. \nThe localconfigurationmanager will perform the following steps to verify the digital signatures.\n* Verify the signature on a configuration file (.MOF) is valid. It uses the powershell cmdlet [Get-AuthenticodeSignature](https://technet.microsoft.com/library/hh849805.aspx), which is extended in 5.1 to support MOF sigature validation.\n* Verify the certificate authority that authorized the signer is trusted.\n* Download module/resource dependencies of the configuration to a temp location.\n* Verify the signature of the catalog included inside the module.\n    * Find a <moduleName>.cat file and verify its signature using the cmdlet  [Get-AuthenticodeSignature](https://technet.microsoft.com/library/hh849805.aspx).\n    * Verify the certification authority that authenticated the signer is trusted.\n    * Verify the content of the modules has not been tampered using the new cmdlet [Test-FileCatalog](https://technet.microsoft.com/library/cc732148.aspx).\n* Install-module to $env:ProgramFiles\\WindowsPowerShell\\Modules\\\n* Process configuration.\n\nNote: - Signature validation on module-catalog and configuration is only performed when the configuration is applied to the system for the first time or when the module is downloaded and installed. Consistency run does not validate signature of Current.mof or its module dependencies.\nIf verification has failed at any stage, for instance if the configuration pulled from the pullserver is unsigned, then processing of the configuration will be terminated with the error shown below and all temporary files will be deleted.\n\n![Sample Error Output Configuration](../../images/PullUnsignedConfigFail.PNG)\n\nSimilarily, Pulling a module whose catalog is not signed will result in the following error:-\n\n![Sample Error Output Module](../../images/PullUnisgnedCatalog.PNG)\n\n####PUSH\nA configuration delivered via push might be tampered at its source before it is delivered to the node. The Local configuration manager will perform similar signature validation steps for pushed or published configuration(s).\nBelow is a complete example of signature validation for push.\n\n* Enable signature validation on the node.\n\n```Powershell\n[DSCLocalConfigurationManager()]\nConfiguration EnableSignatureValidation\n{\n    Settings\n    {\n        RefreshMode = 'PUSH'        \n    } \n    SignatureValidation validations{\n        TrustedStorePath = 'Cert:\\LocalMachine\\DSCStore'   \n        SignedItemType =  'Configuration','Module'             \n    }\n\n}\nEnableSignatureValidation\nSet-DscLocalConfigurationManager -Path .\\EnableSignatureValidation -Verbose\n``` \n* Create a sample configuration file.\n\n```Powershell\n# Sample configuration\nConfiguration Test{\n\n    File foo\n    {\n        DestinationPath =  \"$env:TEMP\\signingTest.txt\"\n        Contents = \"ABC\"\n    }\n}\nTest\n```\n\n* Try pushing the unsigned configuration file in to the node. \n\n```Powershell\nStart-DscConfiguration -Path .\\Test -Wait -Verbose -Force\n``` \n![ErrorUnsignedMofPushed](../../images/PushUnsignedMof.PNG)\n\n* Sign the configurtion file using code-signing cert.\n\n![SignMofFile](../../images/SignMofFile.PNG)\n\n* Try pushing the signed mof file.\n\n![SignMofFile](../../images/PushSignedMof.PNG)\n\n"}